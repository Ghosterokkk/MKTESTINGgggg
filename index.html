<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Медицинский тест для сотрудников</title>
    <link rel="icon" type="image/png" href="Med.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: #8B0000 !important;
            color: white !important;
            padding: 20px 0;
            text-align: center;
            border-radius: 8px 8px 0 0;
            margin-bottom: 20px;
            position: relative;
        }
        
        h1 {
            font-size: 28px;
            margin-bottom: 10px;
            color: #ffffff !important;
            text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px #ff0000, 0 0 20px #ff0000;
            animation: neonGlow 2s ease-in-out infinite alternate;
        }
        
        @keyframes neonGlow {
            from {
                text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px #ff0000, 0 0 20px #ff0000;
            }
            to {
                text-shadow: 0 0 10px #fff, 0 0 15px #fff, 0 0 20px #ff0000, 0 0 25px #ff0000, 0 0 30px #ff0000;
            }
        }
        
        .description {
            font-size: 16px;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .admin-buttons {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .admin-buttons .btn {
            padding: 6px 10px;
            font-size: 12px;
        }
        
        @media (max-width: 768px) {
            .admin-buttons {
                position: static;
                margin-top: 10px;
                justify-content: center;
            }
        }
        
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-bottom: 20px;
            transition: background-color 0.3s;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        input[type="email"],
        input[type="text"],
        input[type="number"],
        input[type="password"],
        textarea,
        select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus,
        textarea:focus,
        select:focus {
            border-color: #8B0000;
            outline: none;
        }
        
        .btn {
            background-color: #8B0000;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.3s;
            display: inline-block;
            text-align: center;
        }
        
        .btn:hover {
            background-color: #A52A2A;
        }
        
        .btn-block {
            display: block;
            width: 100%;
        }
        
        .btn-secondary {
            background-color: #5f6368;
        }
        
        .btn-secondary:hover {
            background-color: #4a4d52;
        }
        
        .btn-danger {
            background-color: #d93025;
        }
        
        .btn-danger:hover {
            background-color: #c5221f;
        }
        
        .btn-success {
            background-color: #0b8043;
        }
        
        .btn-success:hover {
            background-color: #096b38;
        }
        
        .btn-warning {
            background-color: #f9ab00;
        }
        
        .btn-warning:hover {
            background-color: #e09a00;
        }
        
        .btn-info {
            background-color: #1a73e8;
        }
        
        .btn-info:hover {
            background-color: #1669d9;
        }
        
        .btn-disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .btn-disabled:hover {
            background-color: #cccccc;
        }
        
        .test-section {
            display: none;
        }
        
        .question {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .question:last-child {
            border-bottom: none;
        }
        
        .question-text {
            font-weight: 600;
            margin-bottom: 15px;
            font-size: 18px;
            white-space: pre-line;
        }
        
        .options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .option {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .option:hover {
            background-color: #f9f9f9;
        }
        
        .option.selected {
            background-color: #ffe6e6;
            border-color: #8B0000;
        }
        
        .option input {
            margin-right: 10px;
        }
        
        .results {
            text-align: center;
            padding: 30px;
        }
        
        .score {
            font-size: 24px;
            font-weight: 700;
            color: #8B0000;
            margin: 20px 0;
        }
        
        .message {
            font-size: 18px;
            margin-bottom: 20px;
        }
        
        .hidden {
            display: none;
        }
        
        .error {
            color: #d93025;
            font-size: 14px;
            margin-top: 5px;
        }
        
        .success {
            color: #0b8043;
            font-size: 14px;
            margin-top: 5px;
        }
        
        footer {
            text-align: center;
            margin-top: 30px;
            color: #666;
            font-size: 14px;
        }
        
        .timer {
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        
        .timer.warning {
            background-color: #fce8e6;
            color: #d93025;
        }
        
        .question-timer {
            font-size: 14px;
            color: #5f6368;
            margin-bottom: 10px;
        }
        
        .admin-panel {
            display: none;
        }
        
        .curator-panel {
            display: none;
        }
        
        .question-item {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #f8f9fa;
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .question-actions {
            display: flex;
            gap: 10px;
        }
        
        .option-input {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .option-input input {
            flex: 1;
            margin-right: 10px;
        }
        
        .correct-option {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }
        
        .correct-option select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            border-bottom-color: #8B0000;
            font-weight: 600;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .question-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .question-counter {
            text-align: center;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .login-form {
            max-width: 400px;
            margin: 0 auto;
        }
        
        .time-expired {
            background-color: #fce8e6;
            border: 1px solid #f28b82;
            padding: 20px;
            border-radius: 4px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .results-details {
            text-align: left;
            margin-top: 30px;
        }
        
        .result-item {
            margin-bottom: 25px;
            padding: 15px;
            border-radius: 4px;
            background-color: #f8f9fa;
        }
        
        .result-item.correct {
            border-left: 4px solid #0b8043;
        }
        
        .result-item.incorrect {
            border-left: 4px solid #d93025;
        }
        
        .result-item.unanswered {
            border-left: 4px solid #5f6368;
        }
        
        .result-question {
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .result-answer {
            margin-bottom: 5px;
        }
        
        .correct-answer {
            color: #0b8043;
            font-weight: 600;
        }
        
        .user-answer {
            color: #8B0000;
        }
        
        .incorrect-answer {
            color: #d93025;
            font-weight: 600;
        }
        
        .unanswered {
            color: #5f6368;
            font-style: italic;
        }
        
        .results-summary {
            display: flex;
            justify-content: space-around;
            margin: 30px 0;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        
        .summary-item {
            text-align: center;
        }
        
        .summary-value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .summary-label {
            font-size: 14px;
            color: #5f6368;
        }
        
        .user-item {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #f8f9fa;
        }
        
        .user-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .user-actions {
            display: flex;
            gap: 10px;
        }
        
        .user-info {
            margin-bottom: 10px;
        }
        
        .user-role {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .role-doctor {
            background-color: #d93025;
            color: white;
        }
        
        .role-medic {
            background-color: #1a73e8;
            color: white;
        }
        
        .role-sanitary {
            background-color: #f9ab00;
            color: black;
        }
        
        .role-admin {
            background-color: #8B0000;
            color: white;
        }
        
        .role-curator {
            background-color: #0b8043;
            color: white;
        }
        
        .role-junior-sergeant {
            background-color: #0b8f00;
            color: white;
        }
        
        .role-sergeant {
            background-color: #8b8f00;
            color: white;
        }
        
        .role-junior-officer {
            background-color: #1a73e8;
            color: white;
        }
        
        .role-commander {
            background-color: #6a0dad;
            color: white;
        }
        
        .user-stats {
            font-size: 14px;
            color: #5f6368;
        }
        
        .user-assignments {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
        }
        
        .assignment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .assignment-item:last-child {
            border-bottom: none;
        }

        .question-editor {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .question-editor h3 {
            margin-bottom: 15px;
            color: #8B0000;
        }
        
        .option-editor {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .option-editor input {
            flex: 1;
            margin-right: 10px;
        }
        
        .option-editor .btn {
            padding: 8px 12px;
            font-size: 14px;
        }
        
        .time-input {
            width: 100px;
            margin-right: 10px;
        }
        
        .question-time {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }
        
        .question-time label {
            margin-right: 10px;
            margin-bottom: 0;
        }
        
        .firebase-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
        }
        
        .firebase-connected {
            background-color: #0b8043;
            color: white;
        }
        
        .firebase-disconnected {
            background-color: #d93025;
            color: white;
        }
        
        .firebase-no-permission {
            background-color: #f9ab00;
            color: black;
        }
        
        .user-editor {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .user-editor h3 {
            margin-bottom: 15px;
            color: #8B0000;
        }
        
        .back-btn {
            background-color: #5f6368;
            margin-bottom: 15px;
        }
        
        .back-btn:hover {
            background-color: #4a4d52;
        }
        
        .user-answer.correct {
            color: #0b8043;
            font-weight: 600;
        }

        .user-unit {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .unit-medical-corps {
            background-color: #ff0000;
            color: white;
        }
        
        .unit-212 {
            background-color: #fd7e14;
            color: white;
        }
        
        .unit-501 {
            background-color: #1e3a8a;
            color: white;
        }
        
        .unit-41 {
            background-color: #166534;
            color: white;
        }
        
        .unit-cg {
            background-color: #991b1b;
            color: white;
        }
        
        .unit-crimea {
            background-color: #7e22ce;
            color: white;
        }
        
        .unit-attached {
            background-color: #4f46e5;
            color: white;
        }
        
        .unit-none {
            background-color: transparent;
            color: #6c757d;
            border: 1px solid #6c757d;
        }

        .test-selection {
            text-align: center;
        }
        
        .test-option {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .test-option:hover {
            border-color: #8B0000;
            background-color: #f9f9f9;
        }
        
        .test-option.selected {
            border-color: #8B0000;
            background-color: #ffe6e6;
        }
        
        .test-option.completed {
            border-color: #0b8043;
            background-color: #e6f4ea;
            cursor: default;
        }
        
        .test-option.completed:hover {
            border-color: #0b8043;
            background-color: #e6f4ea;
        }
        
        .completed-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #0b8043;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .test-option h3 {
            color: #8B0000;
            margin-bottom: 10px;
        }
        
        .test-option.completed h3 {
            color: #0b8043;
        }
        
        .test-info {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }

        .filters {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        
        .filter-group {
            margin-bottom: 0;
        }
        
        .filter-group label {
            font-size: 14px;
            margin-bottom: 5px;
        }

        .user-answers-list {
            margin-top: 20px;
        }
        
        .user-answer-item {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #f8f9fa;
        }
        
        .user-answer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .user-answer-details {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
        }
        
        .answer-question {
            margin-bottom: 10px;
            padding: 10px;
            background-color: white;
            border-radius: 4px;
        }
        
        .answer-question.correct {
            border-left: 4px solid #0b8043;
        }
        
        .answer-question.incorrect {
            border-left: 4px solid #d93025;
        }
        
        .answer-question.unanswered {
            border-left: 4px solid #5f6368;
        }
        
        /* Модальное окно для редактирования вопроса */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }
        
        .modal-header h3 {
            margin: 0;
            color: #8B0000;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .close-modal:hover {
            color: #333;
        }
        
        .question-textarea {
            min-height: 100px;
            font-family: inherit;
            line-height: 1.5;
            white-space: pre-wrap;
        }
        
        .excellent-score-input {
            width: 120px;
        }
        
        /* Стили для снега */
        .snowflake {
            position: fixed;
            top: -10px;
            color: white;
            font-size: 1em;
            text-shadow: 0 0 5px white;
            user-select: none;
            z-index: 9999;
            pointer-events: none;
            opacity: 0.8;
        }
        
        .snowflake:before {
            content: '❄';
        }
        
        /* Настройки цветов фона */
        .color-option {
            display: inline-block;
            width: 30px;
            height: 30px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid transparent;
        }
        
        .color-option:hover {
            border-color: #333;
        }
        
        .color-option.selected {
            border-color: #8B0000;
            transform: scale(1.1);
        }
        
        .color-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .color-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .color-input-group input[type="color"] {
            width: 50px;
            height: 40px;
            padding: 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .color-input-group input[type="text"] {
            flex: 1;
            min-width: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
        }
        
        .color-preview {
            width: 40px;
            height: 40px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-left: 10px;
        }
        
        .manual-color-section {
            margin-top: 20px;
            padding: 15px;
            border: 1px dashed #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        
        .instruction-text {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
            line-height: 1.4;
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            border-left: 3px solid #8B0000;
        }
        
        .instruction-text code {
            background-color: #e8e8e8;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 12px;
        }
        
        .instruction-text ul {
            margin-top: 5px;
            padding-left: 20px;
        }
        
        .instruction-text li {
            margin-bottom: 3px;
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            .card {
                padding: 20px;
            }
            
            .admin-buttons {
                position: static;
                margin-top: 10px;
            }
            
            .question-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .question-actions {
                margin-top: 10px;
                width: 100%;
                justify-content: space-between;
            }
            
            .results-summary {
                flex-direction: column;
                gap: 15px;
            }
            
            .user-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .user-actions {
                margin-top: 10px;
                width: 100%;
                justify-content: space-between;
            }
            
            .option-editor {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .option-editor input {
                width: 100%;
                margin-right: 0;
                margin-bottom: 5px;
            }
            
            .firebase-status {
                position: static;
                margin-bottom: 10px;
            }
            
            .filters {
                grid-template-columns: 1fr;
            }
            
            .user-answer-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .modal-content {
                margin: 10% auto;
                width: 95%;
                padding: 20px;
            }
            
            .color-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .color-input-group {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .color-input-group input[type="text"] {
                width: 100%;
            }
            
            .color-preview {
                margin-left: 0;
                margin-top: 10px;
            }
        }
        
        .firebase-config-card {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .firebase-config-card h3 {
            color: #856404;
            margin-bottom: 10px;
        }
        
        .firebase-config-card ol {
            padding-left: 20px;
            margin-bottom: 15px;
        }
        
        .firebase-config-card li {
            margin-bottom: 5px;
        }
        
        .firebase-config-card code {
            background-color: #f8f9fa;
            padding: 2px 4px;
            border-radius: 4px;
            font-family: monospace;
        }
        
        /* Стили для отображения текста с сохранением форматирования */
        .preserve-formatting {
            white-space: pre-line;
            word-wrap: break-word;
            line-height: 1.5;
        }
        
        /* Стили для настроек сайта */
        .site-settings-group {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f8f9fa;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
        }
        
        .checkbox-group label {
            margin-bottom: 0;
            cursor: pointer;
        }
        
        .snow-preview {
            width: 100%;
            height: 150px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 10px;
            background-color: #1a237e;
            position: relative;
            overflow: hidden;
        }
        
        .test-completed-info {
            background-color: #e6f4ea;
            border: 1px solid #0b8043;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .test-completed-info h3 {
            color: #0b8043;
            margin-bottom: 10px;
        }
        
        /* Стили для блоков недоступных функций */
        .disabled-feature {
            opacity: 0.5;
            pointer-events: none;
            position: relative;
        }
        
        .disabled-feature::before {
            content: "Доступно только администраторам";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            z-index: 10;
            white-space: nowrap;
            display: none;
        }
        
        .disabled-feature:hover::before {
            display: block;
        }

        /* Новые стили для системы взводов и лекций */
        .platoon-item {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #f8f9fa;
        }
        
        .platoon-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .platoon-actions {
            display: flex;
            gap: 10px;
        }
        
        .platoon-info {
            font-size: 14px;
            color: #5f6368;
            margin-bottom: 5px;
        }
        
        .platoon-members {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
        }
        
        .platoon-member {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        
        .platoon-member:last-child {
            border-bottom: none;
        }
        
        .lecture-item {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #f8f9fa;
        }
        
        .lecture-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .lecture-actions {
            display: flex;
            gap: 10px;
        }
        
        .lecture-info {
            font-size: 14px;
            color: #5f6368;
            margin-bottom: 5px;
        }
        
        .lecture-content {
            margin-top: 15px;
            padding: 15px;
            background-color: white;
            border-radius: 4px;
            border: 1px solid #eee;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-line;
        }
        
        .lecture-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .status-pending {
            background-color: #f9ab00;
            color: black;
        }
        
        .status-approved {
            background-color: #0b8043;
            color: white;
        }
        
        .status-rejected {
            background-color: #d93025;
            color: white;
        }
        
        .status-draft {
            background-color: #5f6368;
            color: white;
        }
        
        .commander-panel {
            display: none;
        }
        
        .user-platoon {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
            background-color: #6a0dad;
            color: white;
        }
        
        .platoon-selector {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            margin-bottom: 15px;
        }
        
        .platoon-selector .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        
        .lecture-filters {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        
        .lecture-editor {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .lecture-editor h3 {
            margin-bottom: 15px;
            color: #8B0000;
        }
        
        .user-platoon-assign {
            margin-top: 10px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 4px;
        }
        
        .platoon-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
            font-size: 12px;
            color: #666;
        }
        
        .lecture-assignments {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }
        
        .lecture-assignment-item {
            padding: 10px;
            margin-bottom: 10px;
            background-color: white;
            border-radius: 4px;
            border: 1px solid #eee;
        }
        
        .lecture-assignment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .commander-notes {
            margin-top: 10px;
            padding: 10px;
            background-color: #fff3cd;
            border-radius: 4px;
            border-left: 3px solid #f9ab00;
        }
        
        .lecture-history {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }
        
        .history-item {
            padding: 8px;
            margin-bottom: 8px;
            background-color: white;
            border-radius: 4px;
            border-left: 3px solid #ddd;
            font-size: 12px;
            color: #666;
        }
        
        .history-approved {
            border-left-color: #0b8043;
        }
        
        .history-rejected {
            border-left-color: #d93025;
        }
        
        .history-pending {
            border-left-color: #f9ab00;
        }
        
        .platoon-commander {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
            background-color: #6a0dad;
            color: white;
        }
        
        .commander-only {
            border-left: 4px solid #6a0dad;
            padding-left: 10px;
        }
    </style>
</head>
<body>
    <!-- Снежинки будут добавляться сюда -->
    <div id="snow-container"></div>
    
    <div class="firebase-status hidden" id="firebase-status"></div>
    
    <!-- Модальное окно для редактирования вопроса -->
    <div id="question-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Редактирование вопроса</h3>
                <button class="close-modal" id="close-modal">&times;</button>
            </div>
            
            <div class="form-group">
                <label for="modal-question-text">Текст вопроса (поддерживаются переносы строк)</label>
                <textarea id="modal-question-text" class="question-textarea" rows="4" placeholder="Введите текст вопроса с возможностью переноса строк"></textarea>
            </div>
            
            <div class="form-group">
                <label>Варианты ответов</label>
                <div id="modal-options-container">
                </div>
                <button class="btn btn-secondary" id="modal-add-option">Добавить вариант</button>
            </div>
            
            <div class="form-group">
                <label for="modal-correct-answer">Правильный ответ</label>
                <select id="modal-correct-answer">
                    <option value="">-- Выберите правильный ответ --</option>
                </select>
            </div>
            
            <div class="question-time">
                <label for="modal-question-time">Время на вопрос (секунды):</label>
                <input type="number" id="modal-question-time" class="time-input" min="10" value="60">
            </div>
            
            <div class="form-group">
                <button class="btn btn-success" id="modal-save-question">Сохранить вопрос</button>
                <button class="btn btn-secondary" id="modal-cancel-edit">Отмена</button>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно для редактирования лекции -->
    <div id="lecture-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="lecture-modal-title">Редактирование лекции</h3>
                <button class="close-modal" id="close-lecture-modal">&times;</button>
            </div>
            
            <div class="form-group">
                <label for="lecture-topic">Тема лекции</label>
                <input type="text" id="lecture-topic" placeholder="Введите тему лекции">
            </div>
            
            <div class="form-group">
                <label for="lecture-content">Содержание лекции (поддерживаются переносы строк)</label>
                <textarea id="lecture-content" class="question-textarea" rows="8" placeholder="Введите содержание лекции"></textarea>
            </div>
            
            <div class="form-group" id="lecture-notes-section" style="display: none;">
                <label for="lecture-notes">Заметки коменданта</label>
                <textarea id="lecture-notes" class="question-textarea" rows="4" placeholder="Введите заметки для автора лекции" readonly></textarea>
            </div>
            
            <div class="form-group">
                <label for="lecture-status">Статус лекции</label>
                <select id="lecture-status" disabled>
                    <option value="draft">Черновик</option>
                    <option value="pending">На проверке</option>
                    <option value="approved">Одобрено</option>
                    <option value="rejected">Отклонено</option>
                </select>
            </div>
            
            <div class="form-group">
                <button class="btn btn-success" id="lecture-save-btn">Сохранить лекцию</button>
                <button class="btn btn-warning" id="lecture-submit-btn">Отправить на проверку</button>
                <button class="btn btn-secondary" id="lecture-cancel-btn">Отмена</button>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно для проверки лекции -->
    <div id="review-lecture-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="review-lecture-modal-title">Проверка лекции</h3>
                <button class="close-modal" id="close-review-lecture-modal">&times;</button>
            </div>
            
            <div class="form-group">
                <label>Автор: <span id="review-lecture-author"></span></label>
            </div>
            
            <div class="form-group">
                <label>Взвод: <span id="review-lecture-platoon"></span></label>
            </div>
            
            <div class="form-group">
                <label>Тема: <span id="review-lecture-topic"></span></label>
            </div>
            
            <div class="form-group">
                <label>Содержание лекции:</label>
                <div id="review-lecture-content" class="lecture-content"></div>
            </div>
            
            <div class="form-group">
                <label for="review-lecture-notes">Заметки коменданта</label>
                <textarea id="review-lecture-notes" class="question-textarea" rows="4" placeholder="Введите заметки для автора лекции"></textarea>
            </div>
            
            <div class="form-group">
                <label for="review-lecture-decision">Решение</label>
                <select id="review-lecture-decision">
                    <option value="">-- Выберите решение --</option>
                    <option value="approved">Одобрить</option>
                    <option value="rejected">Отклонить</option>
                </select>
            </div>
            
            <div class="form-group">
                <button class="btn btn-success" id="review-lecture-approve-btn">Одобрить</button>
                <button class="btn btn-danger" id="review-lecture-reject-btn">Отклонить</button>
                <button class="btn btn-secondary" id="review-lecture-cancel-btn">Отмена</button>
            </div>
        </div>
    </div>
    
    <div class="container">
        <header>
            <h1>Медицинский Тест</h1>
            <p class="description">Система тестирования медицинских знаний и управления взводами</p>
            <div class="admin-buttons" id="admin-buttons">
                <button class="btn" id="commander-toggle">Режим коменданта</button>
                <button class="btn" id="curator-toggle">Режим куратора</button>
                <button class="btn" id="admin-toggle">Режим администратора</button>
            </div>
        </header>
        
        <!-- Инструкция по настройке Firebase -->
        <div class="firebase-config-card" id="firebase-config-help" style="display: none;">
            <h3>⚠️ Настройка правил Firebase</h3>
            <p>Для работы с Firebase необходимо настроить правила безопасности:</p>
            <ol>
                <li>Перейдите в <a href="https://console.firebase.google.com/" target="_blank">консоль Firebase</a></li>
                <li>Выберите проект "medical-test-system"</li>
                <li>В меню слева выберите "Firestore Database"</li>
                <li>Перейдите на вкладку "Rules"</li>
                <li>Замените правила на следующие:</li>
            </ol>
            <code>
rules_version = '2';<br>
service cloud.firestore {<br>
&nbsp;&nbsp;match /databases/{database}/documents {<br>
&nbsp;&nbsp;&nbsp;&nbsp;match /{document=**} {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allow read, write: if true;<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;}<br>
}
            </code>
            <p style="margin-top: 15px; color: #856404;">
                <strong>Внимание:</strong> Эти правила открывают доступ для всех. Для продакшена настройте более строгие правила.
            </p>
            <button class="btn btn-warning" id="hide-firebase-help">Скрыть инструкцию</button>
        </div>
        
        <!-- Панель пользователя -->
        <div id="user-panel">
            <div class="card" id="login-section">
                <h2>Вход в систему</h2>
                <p>Введите ваш логин и пароль для доступа к тестированию и системе лекций</p>
                
                <div class="form-group">
                    <label for="username">Логин</label>
                    <input type="text" id="username" placeholder="Введите ваш логин" required>
                </div>
                
                <div class="form-group">
                    <label for="password">Пароль</label>
                    <input type="password" id="password" placeholder="Введите ваш пароль" required>
                </div>
                
                <div class="error hidden" id="login-error">Неверный логин или пароль</div>
                <div class="error hidden" id="no-assignment-error">Для вашего аккаунта не назначен тест. Обратитесь к администратору.</div>
                
                <button class="btn btn-block" id="login-btn">Войти</button>
            </div>
            
            <div class="card test-section" id="test-selection-section">
                <div class="tabs">
                    <div class="tab active" data-tab="user-tests">Тесты</div>
                    <div class="tab" data-tab="user-lectures">Лекции</div>
                </div>
                
                <div class="tab-content active" id="user-tests-tab">
                    <div class="test-selection">
                        <h2>Выбор теста</h2>
                        <p>Выберите один из назначенных вам тестов для прохождения</p>
                        
                        <div id="available-tests">
                        </div>
                        
                        <button class="btn btn-block" id="start-selected-test" style="margin-top: 20px; display: none;">Начать выбранный тест</button>
                    </div>
                </div>
                
                <div class="tab-content" id="user-lectures-tab">
                    <div class="test-selection">
                        <h2>Мои лекции</h2>
                        <p>Управление вашими лекциями для взвода</p>
                        
                        <div class="lecture-filters">
                            <div class="filter-group">
                                <label for="user-lecture-status">Фильтр по статусу</label>
                                <select id="user-lecture-status">
                                    <option value="">Все статусы</option>
                                    <option value="draft">Черновики</option>
                                    <option value="pending">На проверке</option>
                                    <option value="approved">Одобренные</option>
                                    <option value="rejected">Отклоненные</option>
                                </select>
                            </div>
                        </div>
                        
                        <button class="btn btn-success" id="create-new-lecture" style="margin-bottom: 20px;">Создать новую лекцию</button>
                        
                        <div id="user-lectures-list">
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-secondary" id="back-to-login" style="margin-top: 10px;">Выйти</button>
            </div>
            
            <div class="card test-section" id="test-section">
                <div class="timer" id="timer">Общее время: 30:00</div>
                <div class="question-timer" id="question-timer">Время на вопрос: 60 сек.</div>
                <div class="question-counter" id="question-counter">Вопрос 1 из 3</div>
                
                <h2>Медицинский тест</h2>
                <p>Ответьте на все вопросы. После завершения вы увидите результаты.</p>
                
                <div id="questions-container">
                </div>
                
                <div class="question-navigation">
                    <button class="btn" id="next-question">Следующий вопрос</button>
                </div>
                
                <button class="btn btn-block" id="submit-test" style="margin-top: 20px; display: none;">Завершить тест</button>
            </div>
            
            <div class="card test-section" id="results-section">
                <div class="results">
                    <h2>Результаты теста</h2>
                    <p class="message" id="result-message"></p>
                    <div class="score" id="score"></div>
                    <p>Пользователь: <span id="current-user"></span></p>
                    <p>Подразделение: <span id="current-unit"></span></p>
                    <p id="current-platoon-info" style="display: none;">Взвод: <span id="current-platoon"></span></p>
                    
                    <div class="results-summary" id="results-summary">
                    </div>
                    
                    <div class="results-details" id="results-details">
                    </div>
                    
                    <button class="btn hidden" id="restart-test">Пройти тест снова</button>
                    <button class="btn btn-secondary" id="logout-btn" style="margin-top: 10px;">Выйти</button>
                </div>
            </div>
        </div>
        
        <!-- Панель коменданта -->
        <div class="commander-panel" id="commander-panel">
            <div class="card hidden" style="margin-bottom: 20px;" id="back-to-user-container-commander">
                <button class="btn btn-secondary btn-block" id="back-to-user-login-commander">← Вернуться к входу пользователей</button>
            </div>
            
            <div class="card" id="commander-login">
                <h2>Вход для коменданта</h2>
                <div class="login-form">
                    <div class="form-group">
                        <label for="commander-username">Логин коменданта</label>
                        <input type="text" id="commander-username" placeholder="Введите логин">
                    </div>
                    
                    <div class="form-group">
                        <label for="commander-password">Пароль коменданта</label>
                        <input type="password" id="commander-password" placeholder="Введите пароль">
                    </div>
                    
                    <div class="error hidden" id="commander-login-error">Неверный логин или пароль</div>
                    
                    <button class="btn btn-block" id="commander-login-btn">Войти как комендант</button>
                </div>
            </div>
            
            <div class="commander-content hidden" id="commander-content">
                <div class="tabs">
                    <div class="tab active" data-tab="commander-platoon">Мой взвод</div>
                    <div class="tab" data-tab="commander-lectures">Проверка лекций</div>
                    <div class="tab" data-tab="commander-lecture-assignments">Назначение тем лекций</div>
                </div>
                
                <div class="tab-content active" id="commander-platoon-tab">
                    <div class="card">
                        <h2>Управление моим взводом</h2>
                        <p>Просмотр информации о вашем взводе и его участниках.</p>
                        
                        <div id="commander-platoon-info">
                        </div>
                        
                        <div id="commander-platoon-members">
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="commander-lectures-tab">
                    <div class="card">
                        <h2>Проверка лекций</h2>
                        <p>Проверка лекций, отправленных участниками вашего взвода на проверку.</p>
                        
                        <div class="lecture-filters">
                            <div class="filter-group">
                                <label for="commander-lecture-status">Фильтр по статусу</label>
                                <select id="commander-lecture-status">
                                    <option value="pending">На проверке</option>
                                    <option value="approved">Одобренные</option>
                                    <option value="rejected">Отклоненные</option>
                                    <option value="">Все статусы</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <label for="commander-lecture-author">Фильтр по автору</label>
                                <select id="commander-lecture-author">
                                    <option value="">Все авторы</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="commander-lectures-list">
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="commander-lecture-assignments-tab">
                    <div class="card">
                        <h2>Назначение тем лекций</h2>
                        <p>Назначайте темы лекций участникам вашего взвода.</p>
                        
                        <div class="form-group">
                            <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; align-items: end;">
                                <div>
                                    <label>Участник взвода</label>
                                    <select id="assign-lecture-user">
                                        <option value="">-- Выберите участника --</option>
                                    </select>
                                </div>
                                <div>
                                    <label>Тема лекции</label>
                                    <input type="text" id="assign-lecture-topic" placeholder="Введите тему лекции">
                                </div>
                                <div>
                                    <button class="btn btn-success" id="assign-lecture">Назначить тему</button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="commander-lecture-assignments-list">
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <button class="btn btn-secondary btn-block" id="user-mode-commander">Вернуться в режим пользователя</button>
                    <button class="btn btn-danger btn-block" id="commander-logout" style="margin-top: 10px;">Выйти из панели коменданта</button>
                </div>
            </div>
        </div>
        
        <!-- Панель куратора -->
        <div class="curator-panel" id="curator-panel">
            <div class="card hidden" style="margin-bottom: 20px;" id="back-to-user-container-curator">
                <button class="btn btn-secondary btn-block" id="back-to-user-login-curator">← Вернуться к входу пользователей</button>
            </div>
            
            <div class="card" id="curator-login">
                <h2>Вход для куратора</h2>
                <div class="login-form">
                    <div class="form-group">
                        <label for="curator-username">Логин куратора</label>
                        <input type="text" id="curator-username" placeholder="Введите логин">
                    </div>
                    
                    <div class="form-group">
                        <label for="curator-password">Пароль куратора</label>
                        <input type="password" id="curator-password" placeholder="Введите пароль">
                    </div>
                    
                    <div class="error hidden" id="curator-login-error">Неверный логин или пароль</div>
                    
                    <button class="btn btn-block" id="curator-login-btn">Войти как куратор</button>
                </div>
            </div>
            
            <div class="curator-content hidden" id="curator-content">
                <div class="tabs">
                    <div class="tab active" data-tab="curator-users">Управление пользователями</div>
                    <div class="tab" data-tab="curator-assignments">Назначение тестов</div>
                    <div class="tab" data-tab="curator-user-answers">Результаты ответов пользователей</div>
                    <div class="tab" data-tab="curator-lectures">Просмотр лекций</div>
                </div>
                
                <div class="tab-content active" id="curator-users-tab">
                    <div class="card">
                        <h2>Управление пользователями</h2>
                        <p>Создавайте и управляйте учетными записями пользователей.</p>
                        
                        <div class="form-group">
                            <h3>Добавить нового пользователя</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; align-items: end;">
                                <div>
                                    <label>Логин</label>
                                    <input type="text" id="new-user-login-curator" placeholder="Логин пользователя">
                                </div>
                                <div>
                                    <label>Пароль</label>
                                    <input type="password" id="new-user-password-curator" placeholder="Пароль пользователя">
                                </div>
                                <div>
                                    <button class="btn btn-success" id="add-user-curator">Добавить пользователя</button>
                                </div>
                            </div>
                            <div class="success hidden" id="user-add-success-curator">Пользователь успешно добавлен!</div>
                            <div class="error hidden" id="user-add-error-curator"></div>
                        </div>

                        <div class="user-editor hidden" id="user-editor-curator">
                            <h3>Редактирование пользователя</h3>
                            
                            <div class="form-group">
                                <label for="edit-user-login-curator">Логин</label>
                                <input type="text" id="edit-user-login-curator" placeholder="Логин пользователя">
                            </div>
                            
                            <div class="form-group">
                                <label for="edit-user-password-curator">Пароль</label>
                                <input type="password" id="edit-user-password-curator" placeholder="Новый пароль (оставьте пустым, чтобы не менять)">
                            </div>
                            
                            <div class="form-group">
                                <label for="edit-user-role-curator">Роль</label>
                                <select id="edit-user-role-curator">
                                    <option value="junior-sergeant">Младший Сержантский Состав</option>
                                    <option value="sergeant">Сержантский Состав</option>
                                    <option value="junior-officer">Младший Офицерский Состав</option>
                                    <option value="sanitary">Полевой Санитар</option>
                                    <option value="medic">Полевой Фельдшер</option>
                                    <option value="doctor">Полевой Врач</option>
                                    <option value="commander">Комендант взвода</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="edit-user-unit-curator">Подразделение</label>
                                <select id="edit-user-unit-curator">
                                    <option value="none">Нету</option>
                                    <option value="medical-corps">Медицинский Корпус</option>
                                    <option value="212">212</option>
                                    <option value="501">501</option>
                                    <option value="41">41</option>
                                    <option value="cg">CG</option>
                                    <option value="attached">Прикомандированный</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="edit-user-platoon-curator">Взвод</label>
                                <select id="edit-user-platoon-curator">
                                    <option value="">Без взвода</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <button class="btn btn-success" id="save-user-curator">Сохранить изменения</button>
                                <button class="btn btn-secondary" id="cancel-user-edit-curator">Отмена</button>
                            </div>
                        </div>
                        
                        <div id="users-list-curator">
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="curator-assignments-tab">
                    <div class="card">
                        <h2>Назначение тестов</h2>
                        <p>Назначайте конкретные наборы вопросов пользователям.</p>
                        
                        <div class="filters">
                            <div class="filter-group">
                                <label for="filter-unit-curator">Фильтр по подразделению</label>
                                <select id="filter-unit-curator">
                                    <option value="">Все подразделения</option>
                                    <option value="none">Нету</option>
                                    <option value="medical-corps">Медицинский Корпус</option>
                                    <option value="212">212</option>
                                    <option value="501">501</option>
                                    <option value="41">41</option>
                                    <option value="cg">CG</option>
                                    <option value="attached">Прикомандированный</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <label for="filter-role-curator">Фильтр по роли</label>
                                <select id="filter-role-curator">
                                    <option value="">Все роли</option>
                                    <option value="junior-sergeant">Младший Сержантский Состав</option>
                                    <option value="sergeant">Сержантский Состав</option>
                                    <option value="junior-officer">Младший Офицерский Состав</option>
                                    <option value="sanitary">Полевой Санитар</option>
                                    <option value="medic">Полевой Фельдшер</option>
                                    <option value="doctor">Полевой Врач</option>
                                    <option value="commander">Комендант взвода</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; align-items: end;">
                                <div>
                                    <label>Пользователь</label>
                                    <select id="assign-user-curator">
                                        <option value="">-- Выберите пользователя --</option>
                                    </select>
                                </div>
                                <div>
                                    <label>Набор вопросов</label>
                                    <select id="assign-question-set-curator">
                                        <option value="">-- Выберите набор --</option>
                                    </select>
                                </div>
                                <div>
                                    <button class="btn btn-success" id="assign-test-curator">Назначить тест</button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="assignments-list-curator">
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="curator-user-answers-tab">
                    <div class="card">
                        <h2>Ответы от пользователей</h2>
                        <p>Просмотр всех ответов пользователей на тесты.</p>
                        
                        <div class="filters">
                            <div class="filter-group">
                                <label for="filter-answers-unit-curator">Фильтр по подразделению</label>
                                <select id="filter-answers-unit-curator">
                                    <option value="">Все подразделения</option>
                                    <option value="none">Нету</option>
                                    <option value="medical-corps">Медицинский Корпус</option>
                                    <option value="212">212</option>
                                    <option value="501">501</option>
                                    <option value="41">41</option>
                                    <option value="cg">CG</option>
                                    <option value="attached">Прикомандированный</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <label for="filter-answers-role-curator">Фильтр по роли</label>
                                <select id="filter-answers-role-curator">
                                    <option value="">Все роли</option>
                                    <option value="junior-sergeant">Младший Сержантский Состав</option>
                                    <option value="sergeant">Сержантский Состав</option>
                                    <option value="junior-officer">Младший Офицерский Состав</option>
                                    <option value="sanitary">Полевой Санитар</option>
                                    <option value="medic">Полевой Фельдшер</option>
                                    <option value="doctor">Полевой Врач</option>
                                    <option value="commander">Комендант взвода</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <label for="filter-answers-test-curator">Фильтр по тесту</label>
                                <select id="filter-answers-test-curator">
                                    <option value="">Все тесты</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="user-answers-list" id="user-answers-list-curator">
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="curator-lectures-tab">
                    <div class="card">
                        <h2>Просмотр лекций</h2>
                        <p>Просмотр всех лекций пользователей.</p>
                        
                        <div class="lecture-filters">
                            <div class="filter-group">
                                <label for="curator-lecture-status">Фильтр по статусу</label>
                                <select id="curator-lecture-status">
                                    <option value="">Все статусы</option>
                                    <option value="draft">Черновики</option>
                                    <option value="pending">На проверке</option>
                                    <option value="approved">Одобренные</option>
                                    <option value="rejected">Отклоненные</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <label for="curator-lecture-platoon">Фильтр по взводу</label>
                                <select id="curator-lecture-platoon">
                                    <option value="">Все взводы</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <label for="curator-lecture-author">Фильтр по автору</label>
                                <select id="curator-lecture-author">
                                    <option value="">Все авторы</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="curator-lectures-list">
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <button class="btn btn-secondary btn-block" id="user-mode-curator">Вернуться в режим пользователя</button>
                    <button class="btn btn-danger btn-block" id="curator-logout" style="margin-top: 10px;">Выйти из панели куратора</button>
                </div>
            </div>
        </div>
        
        <!-- Админ-панель -->
        <div class="admin-panel" id="admin-panel">
            <div class="card hidden" style="margin-bottom: 20px;" id="back-to-user-container">
                <button class="btn btn-secondary btn-block" id="back-to-user-login">← Вернуться к входу пользователей</button>
            </div>
            
            <div class="card" id="admin-login">
                <h2>Вход для администратора</h2>
                <div class="login-form">
                    <div class="form-group">
                        <label for="admin-username">Логин администратора</label>
                        <input type="text" id="admin-username" placeholder="Введите логин">
                    </div>
                    
                    <div class="form-group">
                        <label for="admin-password">Пароль администратора</label>
                        <input type="password" id="admin-password" placeholder="Введите пароль">
                    </div>
                    
                    <div class="error hidden" id="admin-login-error">Неверный логин или пароль</div>
                    
                    <button class="btn btn-block" id="admin-login-btn">Войти как администратор</button>
                </div>
            </div>
            
            <div class="admin-content hidden" id="admin-content">
                <div class="tabs">
                    <div class="tab active" data-tab="users">Управление пользователями</div>
                    <div class="tab" data-tab="platoons">Управление взводами</div>
                    <div class="tab" data-tab="questions">Управление вопросами</div>
                    <div class="tab" data-tab="assignments">Назначение тестов</div>
                    <div class="tab" data-tab="user-answers">Результаты ответов пользователей</div>
                    <div class="tab" data-tab="lectures">Управление лекциями</div>
                    <div class="tab" data-tab="site-settings">Настройки сайта</div>
                </div>
                
                <div class="tab-content active" id="users-tab">
                    <div class="card">
                        <h2>Управление пользователями</h2>
                        <p>Создавайте и управляйте учетными записями пользователей.</p>
                        
                        <div class="form-group">
                            <h3>Добавить нового пользователя</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; align-items: end;">
                                <div>
                                    <label>Логин</label>
                                    <input type="text" id="new-user-login" placeholder="Логин пользователя">
                                </div>
                                <div>
                                    <label>Пароль</label>
                                    <input type="password" id="new-user-password" placeholder="Пароль пользователя">
                                </div>
                                <div>
                                    <button class="btn btn-success" id="add-user">Добавить пользователя</button>
                                </div>
                            </div>
                            <div class="success hidden" id="user-add-success">Пользователь успешно добавлен!</div>
                            <div class="error hidden" id="user-add-error"></div>
                        </div>

                        <div class="user-editor hidden" id="user-editor">
                            <h3>Редактирование пользователя</h3>
                            
                            <div class="form-group">
                                <label for="edit-user-login">Логин</label>
                                <input type="text" id="edit-user-login" placeholder="Логин пользователя">
                            </div>
                            
                            <div class="form-group">
                                <label for="edit-user-password">Пароль</label>
                                <input type="password" id="edit-user-password" placeholder="Новый пароль (оставьте пустым, чтобы не менять)">
                            </div>
                            
                            <div class="form-group">
                                <label for="edit-user-role">Роль</label>
                                <select id="edit-user-role">
                                    <option value="junior-sergeant">Младший Сержантский Состав</option>
                                    <option value="sergeant">Сержантский Состав</option>
                                    <option value="junior-officer">Младший Офицерский Состав</option>
                                    <option value="sanitary">Полевой Санитар</option>
                                    <option value="medic">Полевой Фельдшер</option>
                                    <option value="doctor">Полевой Врач</option>
                                    <option value="commander">Комендант взвода</option>
                                    <option value="curator">Куратор</option>
                                    <option value="admin">Администратор</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="edit-user-unit">Подразделение</label>
                                <select id="edit-user-unit">
                                    <option value="none">Нету</option>
                                    <option value="medical-corps">Медицинский Корпус</option>
                                    <option value="212">212</option>
                                    <option value="501">501</option>
                                    <option value="41">41</option>
                                    <option value="cg">CG</option>
                                    <option value="attached">Прикомандированный</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="edit-user-platoon">Взвод</label>
                                <select id="edit-user-platoon">
                                    <option value="">Без взвода</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <button class="btn btn-success" id="save-user">Сохранить изменения</button>
                                <button class="btn btn-secondary" id="cancel-user-edit">Отмена</button>
                            </div>
                        </div>
                        
                        <div id="users-list">
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="platoons-tab">
                    <div class="card">
                        <h2>Управление взводами</h2>
                        <p>Создавайте и управляйте взводами для организации пользователей.</p>
                        
                        <div class="form-group">
                            <h3>Создать новый взвод</h3>
                            <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: end;">
                                <div>
                                    <label>Название взвода</label>
                                    <input type="text" id="new-platoon-name" placeholder="Введите название взвода">
                                </div>
                                <div>
                                    <button class="btn btn-success" id="add-platoon">Создать взвод</button>
                                </div>
                            </div>
                            <div class="form-group" style="margin-top: 10px;">
                                <label for="new-platoon-commander">Комендант взвода</label>
                                <select id="new-platoon-commander">
                                    <option value="">-- Выберите коменданта --</option>
                                </select>
                            </div>
                            <div class="success hidden" id="platoon-add-success">Взвод успешно создан!</div>
                            <div class="error hidden" id="platoon-add-error"></div>
                        </div>
                        
                        <div class="platoon-editor hidden" id="platoon-editor">
                            <h3>Редактирование взвода</h3>
                            
                            <div class="form-group">
                                <label for="edit-platoon-name">Название взвода</label>
                                <input type="text" id="edit-platoon-name" placeholder="Название взвода">
                            </div>
                            
                            <div class="form-group">
                                <label for="edit-platoon-commander">Комендант взвода</label>
                                <select id="edit-platoon-commander">
                                    <option value="">-- Выберите коменданта --</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <button class="btn btn-success" id="save-platoon">Сохранить изменения</button>
                                <button class="btn btn-secondary" id="cancel-platoon-edit">Отмена</button>
                            </div>
                        </div>
                        
                        <div id="platoons-list">
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="questions-tab">
                    <div class="card">
                        <h2>Управление вопросами</h2>
                        <p>Создавайте наборы вопросов для тестирования.</p>
                        
                        <div class="form-group">
                            <label for="question-set-name">Название набора вопросов</label>
                            <input type="text" id="question-set-name" placeholder="Введите название набора">
                            
                            <div class="form-group" style="margin-top: 15px;">
                                <label for="question-set-time">Общее время теста (минуты)</label>
                                <input type="number" id="question-set-time" min="1" value="30">
                            </div>
                            
                            <div class="form-group" style="margin-top: 15px;">
                                <label for="question-set-excellent">Процент для "отлично" (0-100)</label>
                                <input type="number" id="question-set-excellent" min="0" max="100" value="80" class="excellent-score-input">
                            </div>
                            
                            <button class="btn" id="add-question-set" style="margin-top: 10px;">Создать новый набор</button>
                        </div>
                        
                        <div class="form-group">
                            <label for="question-sets">Выберите набор вопросов</label>
                            <select id="question-sets">
                                <option value="">-- Выберите набор --</option>
                            </select>
                        </div>
                        
                        <div class="question-editor hidden" id="question-editor">
                            <h3>Редактирование набора вопросов</h3>
                            
                            <div class="form-group">
                                <label for="edit-set-name">Название набора</label>
                                <input type="text" id="edit-set-name" placeholder="Название набора вопросов">
                            </div>
                            
                            <div class="form-group">
                                <label for="edit-set-time">Общее время теста (минуты)</label>
                                <input type="number" id="edit-set-time" min="1" value="30">
                            </div>
                            
                            <div class="form-group">
                                <label for="edit-set-excellent">Процент для "отлично" (0-100)</label>
                                <input type="number" id="edit-set-excellent" min="0" max="100" value="80" class="excellent-score-input">
                            </div>
                            
                            <div class="form-group">
                                <button class="btn btn-success" id="save-question-set">Сохранить изменения</button>
                                <button class="btn btn-secondary" id="cancel-set-edit">Отмена</button>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <button class="btn" id="add-question">Добавить вопрос в набор</button>
                            <button class="btn btn-warning" id="edit-question-set" style="margin-left: 10px;">Редактировать набор</button>
                        </div>
                        
                        <div id="questions-list">
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="assignments-tab">
                    <div class="card">
                        <h2>Назначение тестов</h2>
                        <p>Назначайте конкретные наборы вопросов пользователям.</p>
                        
                        <div class="filters">
                            <div class="filter-group">
                                <label for="filter-unit">Фильтр по подразделению</label>
                                <select id="filter-unit">
                                    <option value="">Все подразделения</option>
                                    <option value="none">Нету</option>
                                    <option value="medical-corps">Медицинский Корпус</option>
                                    <option value="212">212</option>
                                    <option value="501">501</option>
                                    <option value="41">41</option>
                                    <option value="cg">CG</option>
                                    <option value="attached">Прикомандированный</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <label for="filter-role">Фильтр по роли</label>
                                <select id="filter-role">
                                    <option value="">Все роли</option>
                                    <option value="junior-sergeant">Младший Сержантский Состав</option>
                                    <option value="sergeant">Сержантский Состав</option>
                                    <option value="junior-officer">Младший Офицерский Состав</option>
                                    <option value="sanitary">Полевой Санитар</option>
                                    <option value="medic">Полевой Фельдшер</option>
                                    <option value="doctor">Полевой Врач</option>
                                    <option value="commander">Комендант взвода</option>
                                    <option value="curator">Куратор</option>
                                    <option value="admin">Администратор</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; align-items: end;">
                                <div>
                                    <label>Пользователь</label>
                                    <select id="assign-user">
                                        <option value="">-- Выберите пользователя --</option>
                                    </select>
                                </div>
                                <div>
                                    <label>Набор вопросов</label>
                                    <select id="assign-question-set">
                                        <option value="">-- Выберите набор --</option>
                                    </select>
                                </div>
                                <div>
                                    <button class="btn btn-success" id="assign-test">Назначить тест</button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="assignments-list">
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="results-tab">
                    <div class="card">
                        <h2>Результаты тестов</h2>
                        <p>Просмотр результатов прохождения тестов пользователями.</p>
                        <div id="test-results-list">
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="user-answers-tab">
                    <div class="card">
                        <h2>Ответы от пользователей</h2>
                        <p>Просмотр всех ответов пользователей на тесты.</p>
                        
                        <div class="filters">
                            <div class="filter-group">
                                <label for="filter-answers-unit">Фильтр по подразделению</label>
                                <select id="filter-answers-unit">
                                    <option value="">Все подразделения</option>
                                    <option value="none">Нету</option>
                                    <option value="medical-corps">Медицинский Корпус</option>
                                    <option value="212">212</option>
                                    <option value="501">501</option>
                                    <option value="41">41</option>
                                    <option value="cg">CG</option>
                                    <option value="attached">Прикомандированный</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <label for="filter-answers-role">Фильтр по роли</label>
                                <select id="filter-answers-role">
                                    <option value="">Все роли</option>
                                    <option value="junior-sergeant">Младший Сержантский Состав</option>
                                    <option value="sergeant">Сержантский Состав</option>
                                    <option value="junior-officer">Младший Офицерский Состав</option>
                                    <option value="sanitary">Полевой Санитар</option>
                                    <option value="medic">Полевой Фельдшер</option>
                                    <option value="doctor">Полевой Врач</option>
                                    <option value="commander">Комендант взвода</option>
                                    <option value="curator">Куратор</option>
                                    <option value="admin">Администратор</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <label for="filter-answers-test">Фильтр по тесту</label>
                                <select id="filter-answers-test">
                                    <option value="">Все тесты</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="user-answers-list" id="user-answers-list">
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="lectures-tab">
                    <div class="card">
                        <h2>Управление лекциями</h2>
                        <p>Просмотр и управление лекциями пользователей.</p>
                        
                        <div class="lecture-filters">
                            <div class="filter-group">
                                <label for="admin-lecture-status">Фильтр по статусу</label>
                                <select id="admin-lecture-status">
                                    <option value="">Все статусы</option>
                                    <option value="draft">Черновики</option>
                                    <option value="pending">На проверке</option>
                                    <option value="approved">Одобренные</option>
                                    <option value="rejected">Отклоненные</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <label for="admin-lecture-platoon">Фильтр по взводу</label>
                                <select id="admin-lecture-platoon">
                                    <option value="">Все взводы</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <label for="admin-lecture-author">Фильтр по автору</label>
                                <select id="admin-lecture-author">
                                    <option value="">Все авторы</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="admin-lectures-list">
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="site-settings-tab">
                    <div class="card">
                        <h2>Настройки сайта</h2>
                        <p>Настройте внешний вид сайта.</p>
                        
                        <div class="site-settings-group">
                            <h3>Цвет фона сайта</h3>
                            <p class="instruction-text">
                                <strong>Инструкция:</strong> Выберите цвет из палитры или введите HEX-код вручную.<br>
                                <strong>Формат HEX-кода:</strong> #RRGGBB (например: #f5f7fa)<br>
                                <strong>Примеры популярных цветов:</strong>
                                <ul>
                                    <li>Белый: <code>#ffffff</code></li>
                                    <li>Светло-серый: <code>#f5f7fa</code></li>
                                    <li>Светло-голубой: <code>#e6f7ff</code></li>
                                    <li>Светло-зеленый: <code>#e8f5e9</code></li>
                                    <li>Светло-желтый: <code>#fff8e1</code></li>
                                </ul>
                            </p>
                            
                            <div class="color-input-group">
                                <label for="background-color-picker">Выберите цвет:</label>
                                <input type="color" id="background-color-picker" value="#f5f7fa">
                                <input type="text" id="background-color-hex" placeholder="#f5f7fa" maxlength="7">
                                <div class="color-preview" id="background-color-preview" style="background-color: #f5f7fa;"></div>
                            </div>
                            
                            <div class="color-grid" id="background-color-grid">
                                <div class="color-option selected" style="background-color: #f5f7fa;" data-color="#f5f7fa" title="Светло-серый"></div>
                                <div class="color-option" style="background-color: #ffffff;" data-color="#ffffff" title="Белый"></div>
                                <div class="color-option" style="background-color: #f0f8ff;" data-color="#f0f8ff" title="Алиса блю"></div>
                                <div class="color-option" style="background-color: #fffaf0;" data-color="#fffaf0" title="Цвет морской раковины"></div>
                                <div class="color-option" style="background-color: #f8f8ff;" data-color="#f8f8ff" title="Призрачно-белый"></div>
                                <div class="color-option" style="background-color: #f5f5dc;" data-color="#f5f5dc" title="Бежевый"></div>
                                <div class="color-option" style="background-color: #e6e6fa;" data-color="#e6e6fa" title="Лавандовый"></div>
                                <div class="color-option" style="background-color: #f0fff0;" data-color="#f0fff0" title="Медовая роса"></div>
                                <div class="color-option" style="background-color: #fff0f5;" data-color="#fff0f5" title="Розовый лаванда"></div>
                                <div class="color-option" style="background-color: #f0f0f0;" data-color="#f0f0f0" title="Серый"></div>
                                <div class="color-option" style="background-color: #e6f7ff;" data-color="#e6f7ff" title="Светло-голубой"></div>
                                <div class="color-option" style="background-color: #fff8e1;" data-color="#fff8e1" title="Светло-желтый"></div>
                                <div class="color-option" style="background-color: #f3e5f5;" data-color="#f3e5f5" title="Светло-фиолетовый"></div>
                                <div class="color-option" style="background-color: #e8f5e9;" data-color="#e8f5e9" title="Светло-зеленый"></div>
                                <div class="color-option" style="background-color: #ffebee;" data-color="#ffebee" title="Светло-красный"></div>
                            </div>
                            
                            <p>Текущий цвет: <span id="current-color">#f5f7fa</span></p>
                        </div>
                        
                        <div class="site-settings-group">
                            <h3>Цвет текста сайта</h3>
                            <p class="instruction-text">
                                <strong>Инструкция:</strong> Выберите цвет из палитры или введите HEX-код вручную.<br>
                                <strong>Формат HEX-кода:</strong> #RRGGBB (например: #333333)<br>
                                <strong>Рекомендации:</strong> Используйте темные цвета для лучшей читаемости на светлом фоне.
                            </p>
                            
                            <div class="color-input-group">
                                <label for="text-color-picker">Выберите цвет:</label>
                                <input type="color" id="text-color-picker" value="#333333">
                                <input type="text" id="text-color-hex" placeholder="#333333" maxlength="7">
                                <div class="color-preview" id="text-color-preview" style="background-color: #333333;"></div>
                            </div>
                            
                            <div class="color-grid" id="text-color-grid">
                                <div class="color-option selected" style="background-color: #333333; border: 1px solid #ccc;" data-text-color="#333333" title="Темно-серый"></div>
                                <div class="color-option" style="background-color: #000000; border: 1px solid #ccc;" data-text-color="#000000" title="Черный"></div>
                                <div class="color-option" style="background-color: #2c3e50; border: 1px solid #ccc;" data-text-color="#2c3e50" title="Темно-синий"></div>
                                <div class="color-option" style="background-color: #34495e; border: 1px solid #ccc;" data-text-color="#34495e" title="Серо-синий"></div>
                                <div class="color-option" style="background-color: #7f8c8d; border: 1px solid #ccc;" data-text-color="#7f8c8d" title="Серый"></div>
                                <div class="color-option" style="background-color: #2d3436; border: 1px solid #ccc;" data-text-color="#2d3436" title="Темно-серый"></div>
                                <div class="color-option" style="background-color: #636e72; border: 1px solid #ccc;" data-text-color="#636e72" title="Серый"></div>
                                <div class="color-option" style="background-color: #2f3640; border: 1px solid #ccc;" data-text-color="#2f3640" title="Темный"></div>
                                <div class="color-option" style="background-color: #353b48; border: 1px solid #ccc;" data-text-color="#353b48" title="Серый"></div>
                                <div class="color-option" style="background-color: #40739e; border: 1px solid #ccc;" data-text-color="#40739e" title="Синий"></div>
                            </div>
                            
                            <p>Текущий цвет текста: <span id="current-text-color">#333333</span></p>
                        </div>
                        
                        <div class="site-settings-group">
                            <h3>Падающий снег</h3>
                            <div class="checkbox-group">
                                <input type="checkbox" id="enable-snow">
                                <label for="enable-snow">Включить падающий снег</label>
                            </div>
                            
                            <div class="form-group">
                                <label for="snow-intensity">Интенсивность снега (1-10):</label>
                                <input type="range" id="snow-intensity" min="1" max="10" value="5">
                                <span id="snow-intensity-value">5</span>
                            </div>
                            
                            <div class="form-group">
                                <label for="snow-color">Цвет снежинок:</label>
                                <input type="color" id="snow-color" value="#ffffff">
                            </div>
                            
                            <div class="snow-preview" id="snow-preview">
                                <p style="color: white; text-align: center; padding-top: 60px;">Предпросмотр снега</p>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <button class="btn btn-success" id="save-site-settings">Сохранить настройки</button>
                            <button class="btn btn-secondary" id="reset-site-settings">Сбросить настройки</button>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <button class="btn btn-secondary btn-block" id="user-mode">Вернуться в режим пользователя</button>
                    <button class="btn btn-danger btn-block" id="admin-logout" style="margin-top: 10px;">Выйти из админ-панели</button>
                </div>
            </div>
        </div>
        
        <footer>
            <p>Система Тестирования Медицинского Корпуса © 2025 | Система управления взводами и лекциями</p>
        </footer>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

    <script>
        // 🔥 КОНФИГУРАЦИЯ FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyBUEmsIq-OSw-TZ0HQ6PuhSg1sS4hgyqpI",
            authDomain: "ipk-sait.firebaseapp.com",
            projectId: "ipk-sait",
            storageBucket: "ipk-sait.firebasestorage.app",
            messagingSenderId: "219609478674",
            appId: "1:219609478674:web:a2e9b020cbc46d997e4acb"
        };

        // Инициализация Firebase
        let db;
        let auth;
        let firebaseConnected = false;
        let firebaseHasPermission = false;

        // Функция для обновления статуса Firebase
        function updateFirebaseStatus(status) {
            const statusElement = document.getElementById('firebase-status');
            
            if (status === 'connected') {
                statusElement.textContent = 'Firebase: Подключено ✓';
                statusElement.className = 'firebase-status firebase-connected';
                statusElement.classList.remove('hidden');
            } else if (status === 'no-permission') {
                statusElement.textContent = 'Firebase: Нет прав доступа ⚠️';
                statusElement.className = 'firebase-status firebase-no-permission';
                statusElement.classList.remove('hidden');
            } else {
                statusElement.textContent = 'Firebase: Не подключено (локальный режим)';
                statusElement.className = 'firebase-status firebase-disconnected';
                statusElement.classList.remove('hidden');
            }
        }

        // Инициализация Firebase с улучшенной обработкой ошибок
        function initializeFirebase() {
            try {
                if (typeof firebase === 'undefined' || !firebaseConfig.apiKey) {
                    console.log("⚠️ Firebase не настроен, используется localStorage");
                    updateFirebaseStatus('disconnected');
                    return false;
                }
                
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
                firebaseConnected = true;
                console.log("✅ Firebase инициализирован");
                
                return true;
            } catch (error) {
                console.error("❌ Ошибка инициализации Firebase:", error);
                updateFirebaseStatus('disconnected');
                return false;
            }
        }

        // Тестирование подключения к Firebase с улучшенной обработкой ошибок
        async function testFirebaseConnection() {
            if (!firebaseConnected) {
                updateFirebaseStatus('disconnected');
                return false;
            }
            
            try {
                // Устанавливаем таймаут для запроса
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('Таймаут подключения')), 5000);
                });
                
                // Пробуем выполнить простой запрос для проверки прав
                const testQueryPromise = db.collection('users').limit(1).get();
                const testQuery = await Promise.race([testQueryPromise, timeoutPromise]);
                
                firebaseHasPermission = true;
                console.log("✅ Firebase права доступа подтверждены");
                updateFirebaseStatus('connected');
                
                // Создаем администратора по умолчанию
                await createDefaultAdmin();
                await createDefaultCurator();
                await createDefaultCommander();
                
                return true;
            } catch (error) {
                console.error("❌ Ошибка проверки подключения Firebase:", error);
                
                if (error.code === 'permission-denied' || error.message?.includes('permission')) {
                    console.warn("⚠️ Firebase: недостаточно прав доступа");
                    firebaseHasPermission = false;
                    updateFirebaseStatus('no-permission');
                    showFirebaseHelp();
                } else if (error.message === 'Таймаут подключения') {
                    console.warn("⚠️ Firebase: таймаут подключения");
                    updateFirebaseStatus('disconnected');
                } else {
                    updateFirebaseStatus('disconnected');
                }
                
                return false;
            }
        }

        // Функция для создания администратора по умолчанию
        async function createDefaultAdmin() {
            if (!firebaseConnected || !firebaseHasPermission) return;
            
            try {
                const users = await loadUsers();
                const adminExists = users.some(user => user.role === 'admin');
                
                if (!adminExists) {
                    const defaultAdmin = {
                        login: 'admin',
                        password: 'admin123',
                        role: 'admin',
                        unit: 'none',
                        platoonId: '',
                        createdAt: new Date().toISOString()
                    };
                    
                    await saveUser(defaultAdmin);
                    console.log('✅ Администратор по умолчанию создан');
                }
            } catch (error) {
                console.error('❌ Ошибка создания администратора по умолчанию:', error);
            }
        }

        // Функция для создания куратора по умолчанию
        async function createDefaultCurator() {
            if (!firebaseConnected || !firebaseHasPermission) return;
            
            try {
                const users = await loadUsers();
                const curatorExists = users.some(user => user.role === 'curator');
                
                if (!curatorExists) {
                    const defaultCurator = {
                        login: 'curator',
                        password: 'curator123',
                        role: 'curator',
                        unit: 'none',
                        platoonId: '',
                        createdAt: new Date().toISOString()
                    };
                    
                    await saveUser(defaultCurator);
                    console.log('✅ Куратор по умолчанию создан');
                }
            } catch (error) {
                console.error('❌ Ошибка создания куратора по умолчанию:', error);
            }
        }

        // Функция для создания коменданта по умолчанию
        async function createDefaultCommander() {
            if (!firebaseConnected || !firebaseHasPermission) return;
            
            try {
                const users = await loadUsers();
                const commanderExists = users.some(user => user.role === 'commander');
                
                if (!commanderExists) {
                    const defaultCommander = {
                        login: 'commander',
                        password: 'commander123',
                        role: 'commander',
                        unit: 'medical-corps',
                        platoonId: '',
                        createdAt: new Date().toISOString()
                    };
                    
                    await saveUser(defaultCommander);
                    console.log('✅ Комендант по умолчанию создан');
                }
            } catch (error) {
                console.error('❌ Ошибка создания коменданта по умолчанию:', error);
            }
        }

        function showFirebaseHelp() {
            const helpElement = document.getElementById('firebase-config-help');
            if (helpElement) {
                helpElement.style.display = 'block';
            }
        }

        function hideFirebaseHelp() {
            const helpElement = document.getElementById('firebase-config-help');
            if (helpElement) {
                helpElement.style.display = 'none';
            }
        }

        // Firebase функции для настроек сайта
        async function loadSiteSettingsFromFirebase() {
            try {
                if (!firebaseConnected || !firebaseHasPermission) {
                    return null;
                }

                const doc = await db.collection('siteSettings').doc('global').get();
                if (doc.exists) {
                    return doc.data();
                }
                
                return null;
            } catch (error) {
                console.error('❌ Ошибка загрузки настроек сайта:', error);
                return null;
            }
        }

        async function saveSiteSettingsToFirebase(settings) {
            try {
                if (!firebaseConnected || !firebaseHasPermission) {
                    return null;
                }

                const settingsWithTimestamp = {
                    ...settings,
                    updatedAt: new Date().toISOString()
                };
                
                await db.collection('siteSettings').doc('global').set(settingsWithTimestamp);
                return settingsWithTimestamp;
            } catch (error) {
                console.error('❌ Ошибка сохранения настроек сайта:', error);
                return null;
            }
        }

        // Firebase функции
        async function loadUsers() {
            try {
                if (!firebaseConnected || !firebaseHasPermission) {
                    return getLocalUsers();
                }

                const snapshot = await db.collection('users').get();
                const users = [];
                
                snapshot.forEach(doc => {
                    users.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // Сохраняем в localStorage для оффлайн режима
                if (users.length > 0) {
                    localStorage.setItem('medicalTestUsers', JSON.stringify(users));
                }
                
                return users;
            } catch (error) {
                console.error('❌ Ошибка загрузки пользователей:', error);
                return getLocalUsers();
            }
        }

        async function saveUser(user) {
            try {
                if (!firebaseConnected || !firebaseHasPermission) {
                    return saveUserToLocal(user);
                }

                let savedUser = { ...user };
                
                // Если у пользователя нет ID, создаем нового
                if (!user.id) {
                    const docRef = await db.collection('users').add(user);
                    savedUser.id = docRef.id;
                } else {
                    // Если ID есть, обновляем существующего пользователя
                    await db.collection('users').doc(user.id).set(user, { merge: true });
                }
                
                // Сохраняем в localStorage для оффлайн режима
                saveUserToLocal(savedUser);
                return savedUser;
            } catch (error) {
                console.error('❌ Ошибка сохранения пользователя:', error);
                return saveUserToLocal(user);
            }
        }

        async function deleteUser(userId) {
            try {
                // Удаляем все назначения пользователя
                const assignments = await loadAssignments();
                const userAssignments = assignments.filter(a => a.userId === userId);
                for (const assignment of userAssignments) {
                    await deleteAssignment(assignment.id);
                }
                
                // Удаляем все ответы пользователя
                const userAnswers = await loadUserAnswers();
                const userUserAnswers = userAnswers.filter(ua => ua.userId === userId);
                for (const userAnswer of userUserAnswers) {
                    await deleteUserAnswer(userAnswer.id);
                }
                
                // Удаляем все лекции пользователя
                const lectures = await loadLectures();
                const userLectures = lectures.filter(l => l.userId === userId);
                for (const lecture of userLectures) {
                    await deleteLecture(lecture.id);
                }
                
                if (!firebaseConnected || !firebaseHasPermission) {
                    const users = getLocalUsers();
                    const updatedUsers = users.filter(u => u.id !== userId);
                    localStorage.setItem('medicalTestUsers', JSON.stringify(updatedUsers));
                    return;
                }

                await db.collection('users').doc(userId).delete();
                
                // Удаляем из localStorage
                const users = getLocalUsers();
                const updatedUsers = users.filter(u => u.id !== userId);
                localStorage.setItem('medicalTestUsers', JSON.stringify(updatedUsers));
                
            } catch (error) {
                console.error('❌ Ошибка удаления пользователя:', error);
                
                // Все равно удаляем из localStorage
                const users = getLocalUsers();
                const updatedUsers = users.filter(u => u.id !== userId);
                localStorage.setItem('medicalTestUsers', JSON.stringify(updatedUsers));
            }
        }

        async function loadQuestionSets() {
            try {
                if (!firebaseConnected || !firebaseHasPermission) {
                    return getLocalQuestionSets();
                }

                const snapshot = await db.collection('questionSets').get();
                const questionSets = [];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    questionSets.push({
                        id: doc.id,
                        name: data.name,
                        totalTime: data.totalTime || 30,
                        excellentScore: data.excellentScore || 80,
                        questions: data.questions || []
                    });
                });
                
                // Сохраняем в localStorage для оффлайн режима
                if (questionSets.length > 0) {
                    localStorage.setItem('medicalTestQuestionSets', JSON.stringify(questionSets));
                }
                
                return questionSets;
            } catch (error) {
                console.error('❌ Ошибка загрузки наборов вопросов:', error);
                return getLocalQuestionSets();
            }
        }

        async function saveQuestionSet(questionSet) {
            try {
                if (!firebaseConnected || !firebaseHasPermission) {
                    return saveQuestionSetToLocal(questionSet);
                }

                let savedSet = { ...questionSet };
                
                // Если у набора нет ID, создаем новый
                if (!questionSet.id) {
                    const docRef = await db.collection('questionSets').add(questionSet);
                    savedSet.id = docRef.id;
                } else {
                    // Если ID есть, обновляем существующий набор
                    await db.collection('questionSets').doc(questionSet.id).set(questionSet, { merge: true });
                }
                
                // Сохраняем в localStorage для оффлайн режима
                saveQuestionSetToLocal(savedSet);
                return savedSet;
            } catch (error) {
                console.error('❌ Ошибка сохранения набора вопросов:', error);
                return saveQuestionSetToLocal(questionSet);
            }
        }

        async function deleteQuestionSet(questionSetId) {
            try {
                if (!firebaseConnected || !firebaseHasPermission) {
                    const questionSets = getLocalQuestionSets();
                    const updatedQuestionSets = questionSets.filter(qs => qs.id !== questionSetId);
                    localStorage.setItem('medicalTestQuestionSets', JSON.stringify(updatedQuestionSets));
                    return;
                }

                await db.collection('questionSets').doc(questionSetId).delete();
                
                // Удаляем из localStorage
                const questionSets = getLocalQuestionSets();
                const updatedQuestionSets = questionSets.filter(qs => qs.id !== questionSetId);
                localStorage.setItem('medicalTestQuestionSets', JSON.stringify(updatedQuestionSets));
                
            } catch (error) {
                console.error('❌ Ошибка удаления набора вопросов:', error);
                
                // Все равно удаляем из localStorage
                const questionSets = getLocalQuestionSets();
                const updatedQuestionSets = questionSets.filter(qs => qs.id !== questionSetId);
                localStorage.setItem('medicalTestQuestionSets', JSON.stringify(updatedQuestionSets));
            }
        }

        async function loadAssignments() {
            try {
                if (!firebaseConnected || !firebaseHasPermission) {
                    return getLocalAssignments();
                }

                const snapshot = await db.collection('assignments').get();
                const assignments = [];
                
                snapshot.forEach(doc => {
                    assignments.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // Сохраняем в localStorage для оффлайн режима
                if (assignments.length > 0) {
                    localStorage.setItem('medicalTestAssignments', JSON.stringify(assignments));
                }
                
                return assignments;
            } catch (error) {
                console.error('❌ Ошибка загрузки назначений:', error);
                return getLocalAssignments();
            }
        }

        async function saveAssignment(assignment) {
            try {
                if (!firebaseConnected || !firebaseHasPermission) {
                    return saveAssignmentToLocal(assignment);
                }

                let savedAssignment = { ...assignment };
                
                // Если у назначения нет ID, создаем новое
                if (!assignment.id) {
                    const docRef = await db.collection('assignments').add(assignment);
                    savedAssignment.id = docRef.id;
                } else {
                    // Если ID есть, обновляем существующее назначение
                    await db.collection('assignments').doc(assignment.id).set(assignment, { merge: true });
                }
                
                // Сохраняем в localStorage для оффлайн режима
                saveAssignmentToLocal(savedAssignment);
                return savedAssignment;
            } catch (error) {
                console.error('❌ Ошибка сохранения назначения:', error);
                return saveAssignmentToLocal(assignment);
            }
        }

        async function deleteAssignment(assignmentId) {
            try {
                if (!firebaseConnected || !firebaseHasPermission) {
                    const assignments = getLocalAssignments();
                    const updatedAssignments = assignments.filter(a => a.id !== assignmentId);
                    localStorage.setItem('medicalTestAssignments', JSON.stringify(updatedAssignments));
                    return;
                }

                await db.collection('assignments').doc(assignmentId).delete();
                
                // Удаляем из localStorage
                const assignments = getLocalAssignments();
                const updatedAssignments = assignments.filter(a => a.id !== assignmentId);
                localStorage.setItem('medicalTestAssignments', JSON.stringify(updatedAssignments));
                
            } catch (error) {
                console.error('❌ Ошибка удаления назначения:', error);
                
                // Все равно удаляем из localStorage
                const assignments = getLocalAssignments();
                const updatedAssignments = assignments.filter(a => a.id !== assignmentId);
                localStorage.setItem('medicalTestAssignments', JSON.stringify(updatedAssignments));
            }
        }

        async function loadUserAnswers() {
            try {
                if (!firebaseConnected || !firebaseHasPermission) {
                    return getLocalUserAnswers();
                }

                const snapshot = await db.collection('userAnswers').get();
                const userAnswers = [];
                
                snapshot.forEach(doc => {
                    userAnswers.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // Сохраняем в localStorage для оффлайн режима
                if (userAnswers.length > 0) {
                    localStorage.setItem('medicalTestUserAnswers', JSON.stringify(userAnswers));
                }
                
                return userAnswers;
            } catch (error) {
                console.error('❌ Ошибка загрузки ответов пользователей:', error);
                return getLocalUserAnswers();
            }
        }

        async function saveUserAnswer(userAnswer) {
            try {
                if (!firebaseConnected || !firebaseHasPermission) {
                    return saveUserAnswerToLocal(userAnswer);
                }

                const docRef = await db.collection('userAnswers').add(userAnswer);
                userAnswer.id = docRef.id;
                
                // Сохраняем в localStorage для оффлайн режима
                saveUserAnswerToLocal(userAnswer);
                return userAnswer;
            } catch (error) {
                console.error('❌ Ошибка сохранения ответа пользователя:', error);
                return saveUserAnswerToLocal(userAnswer);
            }
        }

        async function deleteUserAnswer(answerId) {
            try {
                if (!firebaseConnected || !firebaseHasPermission) {
                    const userAnswers = getLocalUserAnswers();
                    const updatedUserAnswers = userAnswers.filter(a => a.id !== answerId);
                    localStorage.setItem('medicalTestUserAnswers', JSON.stringify(updatedUserAnswers));
                    return;
                }

                await db.collection('userAnswers').doc(answerId).delete();
                
                // Удаляем из localStorage
                const userAnswers = getLocalUserAnswers();
                const updatedUserAnswers = userAnswers.filter(a => a.id !== answerId);
                localStorage.setItem('medicalTestUserAnswers', JSON.stringify(updatedUserAnswers));
                
            } catch (error) {
                console.error('❌ Ошибка удаления ответа пользователя:', error);
                
                // Все равно удаляем из localStorage
                const userAnswers = getLocalUserAnswers();
                const updatedUserAnswers = userAnswers.filter(a => a.id !== answerId);
                localStorage.setItem('medicalTestUserAnswers', JSON.stringify(updatedUserAnswers));
            }
        }

        // Новые функции для работы с взводами
        async function loadPlatoons() {
            try {
                if (!firebaseConnected || !firebaseHasPermission) {
                    return getLocalPlatoons();
                }

                const snapshot = await db.collection('platoons').get();
                const platoons = [];
                
                snapshot.forEach(doc => {
                    platoons.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // Сохраняем в localStorage для оффлайн режима
                if (platoons.length > 0) {
                    localStorage.setItem('medicalTestPlatoons', JSON.stringify(platoons));
                }
                
                return platoons;
            } catch (error) {
                console.error('❌ Ошибка загрузки взводов:', error);
                return getLocalPlatoons();
            }
        }

        async function savePlatoon(platoon) {
            try {
                if (!firebaseConnected || !firebaseHasPermission) {
                    return savePlatoonToLocal(platoon);
                }

                let savedPlatoon = { ...platoon };
                
                // Если у взвода нет ID, создаем новый
                if (!platoon.id) {
                    const docRef = await db.collection('platoons').add(platoon);
                    savedPlatoon.id = docRef.id;
                } else {
                    // Если ID есть, обновляем существующий взвод
                    await db.collection('platoons').doc(platoon.id).set(platoon, { merge: true });
                }
                
                // Сохраняем в localStorage для оффлайн режима
                savePlatoonToLocal(savedPlatoon);
                return savedPlatoon;
            } catch (error) {
                console.error('❌ Ошибка сохранения взвода:', error);
                return savePlatoonToLocal(platoon);
            }
        }

        async function deletePlatoon(platoonId) {
            try {
                // Обновляем пользователей этого взвода
                const users = await loadUsers();
                const platoonUsers = users.filter(u => u.platoonId === platoonId);
                for (const user of platoonUsers) {
                    user.platoonId = '';
                    await saveUser(user);
                }
                
                if (!firebaseConnected || !firebaseHasPermission) {
                    const platoons = getLocalPlatoons();
                    const updatedPlatoons = platoons.filter(p => p.id !== platoonId);
                    localStorage.setItem('medicalTestPlatoons', JSON.stringify(updatedPlatoons));
                    return;
                }

                await db.collection('platoons').doc(platoonId).delete();
                
                // Удаляем из localStorage
                const platoons = getLocalPlatoons();
                const updatedPlatoons = platoons.filter(p => p.id !== platoonId);
                localStorage.setItem('medicalTestPlatoons', JSON.stringify(updatedPlatoons));
                
            } catch (error) {
                console.error('❌ Ошибка удаления взвода:', error);
                
                // Все равно удаляем из localStorage
                const platoons = getLocalPlatoons();
                const updatedPlatoons = platoons.filter(p => p.id !== platoonId);
                localStorage.setItem('medicalTestPlatoons', JSON.stringify(updatedPlatoons));
            }
        }

        // Новые функции для работы с лекциями
        async function loadLectures() {
            try {
                if (!firebaseConnected || !firebaseHasPermission) {
                    return getLocalLectures();
                }

                const snapshot = await db.collection('lectures').get();
                const lectures = [];
                
                snapshot.forEach(doc => {
                    lectures.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // Сохраняем в localStorage для оффлайн режима
                if (lectures.length > 0) {
                    localStorage.setItem('medicalTestLectures', JSON.stringify(lectures));
                }
                
                return lectures;
            } catch (error) {
                console.error('❌ Ошибка загрузки лекций:', error);
                return getLocalLectures();
            }
        }

        async function saveLecture(lecture) {
            try {
                if (!firebaseConnected || !firebaseHasPermission) {
                    return saveLectureToLocal(lecture);
                }

                let savedLecture = { ...lecture };
                
                // Если у лекции нет ID, создаем новую
                if (!lecture.id) {
                    const docRef = await db.collection('lectures').add(lecture);
                    savedLecture.id = docRef.id;
                } else {
                    // Если ID есть, обновляем существующую лекцию
                    await db.collection('lectures').doc(lecture.id).set(lecture, { merge: true });
                }
                
                // Сохраняем в localStorage для оффлайн режима
                saveLectureToLocal(savedLecture);
                return savedLecture;
            } catch (error) {
                console.error('❌ Ошибка сохранения лекции:', error);
                return saveLectureToLocal(lecture);
            }
        }

        async function deleteLecture(lectureId) {
            try {
                if (!firebaseConnected || !firebaseHasPermission) {
                    const lectures = getLocalLectures();
                    const updatedLectures = lectures.filter(l => l.id !== lectureId);
                    localStorage.setItem('medicalTestLectures', JSON.stringify(updatedLectures));
                    return;
                }

                await db.collection('lectures').doc(lectureId).delete();
                
                // Удаляем из localStorage
                const lectures = getLocalLectures();
                const updatedLectures = lectures.filter(l => l.id !== lectureId);
                localStorage.setItem('medicalTestLectures', JSON.stringify(updatedLectures));
                
            } catch (error) {
                console.error('❌ Ошибка удаления лекции:', error);
                
                // Все равно удаляем из localStorage
                const lectures = getLocalLectures();
                const updatedLectures = lectures.filter(l => l.id !== lectureId);
                localStorage.setItem('medicalTestLectures', JSON.stringify(updatedLectures));
            }
        }

        // Функции для работы с localStorage
        function getLocalUsers() {
            try {
                const users = localStorage.getItem('medicalTestUsers');
                return users ? JSON.parse(users) : [];
            } catch (error) {
                console.error('❌ Ошибка получения пользователей из localStorage:', error);
                return [];
            }
        }

        function saveUserToLocal(user) {
            try {
                const users = getLocalUsers();
                const existingIndex = users.findIndex(u => u.id === user.id);
                
                if (existingIndex >= 0) {
                    users[existingIndex] = user;
                } else {
                    // Если пользователь без id, генерируем временный
                    if (!user.id) {
                        user.id = 'local_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    }
                    users.push(user);
                }
                
                localStorage.setItem('medicalTestUsers', JSON.stringify(users));
                return user;
            } catch (error) {
                console.error('❌ Ошибка сохранения пользователя в localStorage:', error);
                return user;
            }
        }

        function getLocalQuestionSets() {
            try {
                const questionSets = localStorage.getItem('medicalTestQuestionSets');
                if (questionSets) {
                    const sets = JSON.parse(questionSets);
                    return sets.map(set => ({
                        ...set,
                        totalTime: set.totalTime || 30,
                        excellentScore: set.excellentScore || 80
                    }));
                }
                return [];
            } catch (error) {
                console.error('❌ Ошибка получения наборов вопросов из localStorage:', error);
                return [];
            }
        }

        function saveQuestionSetToLocal(questionSet) {
            try {
                const questionSets = getLocalQuestionSets();
                const existingIndex = questionSets.findIndex(qs => qs.id === questionSet.id);
                
                if (existingIndex >= 0) {
                    questionSets[existingIndex] = questionSet;
                } else {
                    // Если набор без id, генерируем временный
                    if (!questionSet.id) {
                        questionSet.id = 'local_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    }
                    questionSets.push(questionSet);
                }
                
                localStorage.setItem('medicalTestQuestionSets', JSON.stringify(questionSets));
                return questionSet;
            } catch (error) {
                console.error('❌ Ошибка сохранения набора вопросов в localStorage:', error);
                return questionSet;
            }
        }

        function getLocalAssignments() {
            try {
                const assignments = localStorage.getItem('medicalTestAssignments');
                return assignments ? JSON.parse(assignments) : [];
            } catch (error) {
                console.error('❌ Ошибка получения назначений из localStorage:', error);
                return [];
            }
        }

        function saveAssignmentToLocal(assignment) {
            try {
                const assignments = getLocalAssignments();
                const existingIndex = assignments.findIndex(a => a.id === assignment.id);
                
                if (existingIndex >= 0) {
                    assignments[existingIndex] = assignment;
                } else {
                    // Если назначение без id, генерируем временный
                    if (!assignment.id) {
                        assignment.id = 'local_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    }
                    assignments.push(assignment);
                }
                
                localStorage.setItem('medicalTestAssignments', JSON.stringify(assignments));
                return assignment;
            } catch (error) {
                console.error('❌ Ошибка сохранения назначения в localStorage:', error);
                return assignment;
            }
        }

        function getLocalUserAnswers() {
            try {
                const userAnswers = localStorage.getItem('medicalTestUserAnswers');
                return userAnswers ? JSON.parse(userAnswers) : [];
            } catch (error) {
                console.error('❌ Ошибка получения ответов пользователей из localStorage:', error);
                return [];
            }
        }

        function saveUserAnswerToLocal(userAnswer) {
            try {
                const userAnswers = getLocalUserAnswers();
                if (!userAnswer.id) {
                    userAnswer.id = 'local_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                }
                userAnswers.push(userAnswer);
                localStorage.setItem('medicalTestUserAnswers', JSON.stringify(userAnswers));
                return userAnswer;
            } catch (error) {
                console.error('❌ Ошибка сохранения ответа пользователя в localStorage:', error);
                return userAnswer;
            }
        }

        function getLocalPlatoons() {
            try {
                const platoons = localStorage.getItem('medicalTestPlatoons');
                return platoons ? JSON.parse(platoons) : [];
            } catch (error) {
                console.error('❌ Ошибка получения взводов из localStorage:', error);
                return [];
            }
        }

        function savePlatoonToLocal(platoon) {
            try {
                const platoons = getLocalPlatoons();
                const existingIndex = platoons.findIndex(p => p.id === platoon.id);
                
                if (existingIndex >= 0) {
                    platoons[existingIndex] = platoon;
                } else {
                    // Если взвод без id, генерируем временный
                    if (!platoon.id) {
                        platoon.id = 'local_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    }
                    platoons.push(platoon);
                }
                
                localStorage.setItem('medicalTestPlatoons', JSON.stringify(platoons));
                return platoon;
            } catch (error) {
                console.error('❌ Ошибка сохранения взвода в localStorage:', error);
                return platoon;
            }
        }

        function getLocalLectures() {
            try {
                const lectures = localStorage.getItem('medicalTestLectures');
                return lectures ? JSON.parse(lectures) : [];
            } catch (error) {
                console.error('❌ Ошибка получения лекций из localStorage:', error);
                return [];
            }
        }

        function saveLectureToLocal(lecture) {
            try {
                const lectures = getLocalLectures();
                const existingIndex = lectures.findIndex(l => l.id === lecture.id);
                
                if (existingIndex >= 0) {
                    lectures[existingIndex] = lecture;
                } else {
                    // Если лекция без id, генерируем временный
                    if (!lecture.id) {
                        lecture.id = 'local_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    }
                    lectures.push(lecture);
                }
                
                localStorage.setItem('medicalTestLectures', JSON.stringify(lectures));
                return lecture;
            } catch (error) {
                console.error('❌ Ошибка сохранения лекции в localStorage:', error);
                return lecture;
            }
        }

        // Функция для получения отображаемого названия подразделения
        function getUnitDisplayName(unit) {
            const unitNames = {
                'none': 'Нету',
                'medical-corps': 'Медицинский Корпус',
                '212': '212',
                '501': '501',
                '41': '41',
                'cg': 'CG',
                'attached': 'Прикомандированный'
            };
            return unitNames[unit] || 'Неизвестно';
        }

        // Функция для получения CSS класса подразделения
        function getUnitClass(unit) {
            const unitClasses = {
                'none': 'unit-none',
                'medical-corps': 'unit-medical-corps',
                '212': 'unit-212',
                '501': 'unit-501',
                '41': 'unit-41',
                'cg': 'unit-cg',
                'crimea': 'unit-crimea',
                'attached': 'unit-attached'
            };
            return unitClasses[unit] || 'unit-none';
        }

        // Функция для получения отображаемого названия роли
        function getRoleDisplayName(role) {
            const roleNames = {
                'junior-sergeant': 'Младший Сержантский Состав',
                'sergeant': 'Сержантский Состав',
                'junior-officer': 'Младший Офицерский Состав',
                'sanitary': 'Полевой Санитар',
                'medic': 'Полевой Фельдшер',
                'doctor': 'Полевой Врач',
                'commander': 'Комендант взвода',
                'curator': 'Куратор',
                'admin': 'Администратор'
            };
            return roleNames[role] || role;
        }

        // Функция для получения отображаемого названия статуса лекции
        function getLectureStatusDisplayName(status) {
            const statusNames = {
                'draft': 'Черновик',
                'pending': 'На проверке',
                'approved': 'Одобрено',
                'rejected': 'Отклонено'
            };
            return statusNames[status] || status;
        }

        // Функция для получения CSS класса статуса лекции
        function getLectureStatusClass(status) {
            const statusClasses = {
                'draft': 'status-draft',
                'pending': 'status-pending',
                'approved': 'status-approved',
                'rejected': 'status-rejected'
            };
            return statusClasses[status] || 'status-draft';
        }

        // Основная логика приложения
        let currentUser = null;
        let currentQuestionSet = null;
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let totalTime = 30 * 60;
        let questionTime = 60;
        let timerInterval;
        let questionTimerInterval;
        let remainingQuestionTime = 0;
        let selectedAssignment = null;
        let currentEditingQuestionSetId = null;
        let currentEditingQuestionIndex = null;
        let snowInterval = null;
        let currentSiteSettings = null;
        let currentRole = null; // 'admin', 'curator', 'commander', или null
        
        // Переменные для системы лекций
        let currentEditingLectureId = null;
        let currentLectureModalMode = 'create'; // 'create' или 'edit'

        // DOM элементы
        const userPanel = document.getElementById('user-panel');
        const adminPanel = document.getElementById('admin-panel');
        const curatorPanel = document.getElementById('curator-panel');
        const commanderPanel = document.getElementById('commander-panel');
        const adminButtons = document.getElementById('admin-buttons');
        const adminToggle = document.getElementById('admin-toggle');
        const curatorToggle = document.getElementById('curator-toggle');
        const commanderToggle = document.getElementById('commander-toggle');
        const userModeBtn = document.getElementById('user-mode');
        const userModeCuratorBtn = document.getElementById('user-mode-curator');
        const userModeCommanderBtn = document.getElementById('user-mode-commander');
        const adminLogin = document.getElementById('admin-login');
        const curatorLogin = document.getElementById('curator-login');
        const commanderLogin = document.getElementById('commander-login');
        const adminContent = document.getElementById('admin-content');
        const curatorContent = document.getElementById('curator-content');
        const commanderContent = document.getElementById('commander-content');
        const adminLoginBtn = document.getElementById('admin-login-btn');
        const curatorLoginBtn = document.getElementById('curator-login-btn');
        const commanderLoginBtn = document.getElementById('commander-login-btn');
        const adminLogoutBtn = document.getElementById('admin-logout');
        const curatorLogoutBtn = document.getElementById('curator-logout');
        const commanderLogoutBtn = document.getElementById('commander-logout');
        const loginSection = document.getElementById('login-section');
        const testSelectionSection = document.getElementById('test-selection-section');
        const testSection = document.getElementById('test-section');
        const resultsSection = document.getElementById('results-section');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const backToLoginBtn = document.getElementById('back-to-login');
        const startSelectedTestBtn = document.getElementById('start-selected-test');
        const submitTestBtn = document.getElementById('submit-test');
        const restartTestBtn = document.getElementById('restart-test');
        const nextQuestionBtn = document.getElementById('next-question');
        const timerElement = document.getElementById('timer');
        const questionTimerElement = document.getElementById('question-timer');
        const questionCounterElement = document.getElementById('question-counter');
        const questionsContainer = document.getElementById('questions-container');
        const availableTestsContainer = document.getElementById('available-tests');
        const currentUserElement = document.getElementById('current-user');
        const currentUnitElement = document.getElementById('current-unit');
        const currentPlatoonInfo = document.getElementById('current-platoon-info');
        const currentPlatoon = document.getElementById('current-platoon');
        const scoreElement = document.getElementById('score');
        const resultMessageElement = document.getElementById('result-message');
        const resultsSummaryElement = document.getElementById('results-summary');
        const resultsDetailsElement = document.getElementById('results-details');
        const backToUserLoginBtn = document.getElementById('back-to-user-login');
        const backToUserLoginCuratorBtn = document.getElementById('back-to-user-login-curator');
        const backToUserLoginCommanderBtn = document.getElementById('back-to-user-login-commander');
        const backToUserContainer = document.getElementById('back-to-user-container');
        const backToUserContainerCurator = document.getElementById('back-to-user-container-curator');
        const backToUserContainerCommander = document.getElementById('back-to-user-container-commander');
        const hideFirebaseHelpBtn = document.getElementById('hide-firebase-help');

        // Модальное окно элементы
        const questionModal = document.getElementById('question-modal');
        const lectureModal = document.getElementById('lecture-modal');
        const reviewLectureModal = document.getElementById('review-lecture-modal');
        const closeModalBtn = document.getElementById('close-modal');
        const closeLectureModalBtn = document.getElementById('close-lecture-modal');
        const closeReviewLectureModalBtn = document.getElementById('close-review-lecture-modal');
        const modalCancelBtn = document.getElementById('modal-cancel-edit');
        const modalQuestionText = document.getElementById('modal-question-text');
        const modalOptionsContainer = document.getElementById('modal-options-container');
        const modalAddOptionBtn = document.getElementById('modal-add-option');
        const modalCorrectAnswer = document.getElementById('modal-correct-answer');
        const modalQuestionTime = document.getElementById('modal-question-time');
        const modalSaveQuestionBtn = document.getElementById('modal-save-question');
        const modalTitle = document.getElementById('modal-title');

        // Элементы для лекций
        const lectureModalTitle = document.getElementById('lecture-modal-title');
        const lectureTopic = document.getElementById('lecture-topic');
        const lectureContent = document.getElementById('lecture-content');
        const lectureNotesSection = document.getElementById('lecture-notes-section');
        const lectureNotes = document.getElementById('lecture-notes');
        const lectureStatus = document.getElementById('lecture-status');
        const lectureSaveBtn = document.getElementById('lecture-save-btn');
        const lectureSubmitBtn = document.getElementById('lecture-submit-btn');
        const lectureCancelBtn = document.getElementById('lecture-cancel-btn');
        const createNewLectureBtn = document.getElementById('create-new-lecture');

        // Элементы для проверки лекций
        const reviewLectureModalTitle = document.getElementById('review-lecture-modal-title');
        const reviewLectureAuthor = document.getElementById('review-lecture-author');
        const reviewLecturePlatoon = document.getElementById('review-lecture-platoon');
        const reviewLectureTopic = document.getElementById('review-lecture-topic');
        const reviewLectureContent = document.getElementById('review-lecture-content');
        const reviewLectureNotes = document.getElementById('review-lecture-notes');
        const reviewLectureDecision = document.getElementById('review-lecture-decision');
        const reviewLectureApproveBtn = document.getElementById('review-lecture-approve-btn');
        const reviewLectureRejectBtn = document.getElementById('review-lecture-reject-btn');
        const reviewLectureCancelBtn = document.getElementById('review-lecture-cancel-btn');

        // Настройки сайта элементы
        const saveSiteSettingsBtn = document.getElementById('save-site-settings');
        const resetSiteSettingsBtn = document.getElementById('reset-site-settings');
        const enableSnowCheckbox = document.getElementById('enable-snow');
        const snowIntensitySlider = document.getElementById('snow-intensity');
        const snowIntensityValue = document.getElementById('snow-intensity-value');
        const snowColorPicker = document.getElementById('snow-color');
        const snowPreview = document.getElementById('snow-preview');
        const currentColorSpan = document.getElementById('current-color');
        const currentTextColorSpan = document.getElementById('current-text-color');
        const colorOptions = document.querySelectorAll('.color-option[data-color]');
        const textColorOptions = document.querySelectorAll('.color-option[data-text-color]');
        
        // Новые элементы для ручного ввода цвета
        const backgroundColorPicker = document.getElementById('background-color-picker');
        const backgroundColorHex = document.getElementById('background-color-hex');
        const backgroundColorPreview = document.getElementById('background-color-preview');
        const textColorPicker = document.getElementById('text-color-picker');
        const textColorHex = document.getElementById('text-color-hex');
        const textColorPreview = document.getElementById('text-color-preview');
        const backgroundColorGrid = document.getElementById('background-color-grid');
        const textColorGrid = document.getElementById('text-color-grid');

        // Элементы для системы взводов
        const addPlatoonBtn = document.getElementById('add-platoon');
        const newPlatoonName = document.getElementById('new-platoon-name');
        const newPlatoonCommander = document.getElementById('new-platoon-commander');
        const savePlatoonBtn = document.getElementById('save-platoon');
        const cancelPlatoonEditBtn = document.getElementById('cancel-platoon-edit');

        // Инициализация приложения
        document.addEventListener('DOMContentLoaded', async function() {
            // Инициализируем Firebase
            const firebaseInitialized = initializeFirebase();
            
            if (firebaseInitialized) {
                // Тестируем подключение к Firebase
                await testFirebaseConnection();
            }
            
            showLoginSection();
            loadSiteSettings();
            initEventListeners();
            initSiteSettings();
            initModal();
            initColorInputs();
            initLectureModal();
            initReviewLectureModal();
        });

        async function loadSiteSettings() {
            // Настройки по умолчанию
            const defaultSettings = {
                backgroundColor: '#f5f7fa',
                textColor: '#333333',
                snowEnabled: false,
                snowIntensity: 5,
                snowColor: '#ffffff',
                updatedAt: new Date().toISOString()
            };

            // Пытаемся загрузить из Firebase
            if (firebaseConnected && firebaseHasPermission) {
                try {
                    const firebaseSettings = await loadSiteSettingsFromFirebase();
                    if (firebaseSettings) {
                        currentSiteSettings = { ...defaultSettings, ...firebaseSettings };
                        console.log('✅ Настройки сайта загружены из Firebase');
                    } else {
                        currentSiteSettings = defaultSettings;
                    }
                } catch (error) {
                    console.error('❌ Ошибка загрузки настроек из Firebase:', error);
                    currentSiteSettings = defaultSettings;
                }
            } else {
                // Загружаем из localStorage если Firebase недоступен
                const localSettings = JSON.parse(localStorage.getItem('medicalTestSiteSettings') || '{}');
                if (Object.keys(localSettings).length > 0) {
                    currentSiteSettings = { ...defaultSettings, ...localSettings };
                    console.log('✅ Настройки сайта загружены из localStorage');
                } else {
                    currentSiteSettings = defaultSettings;
                }
            }

            // Применяем настройки
            applySiteSettings(currentSiteSettings);
            
            return currentSiteSettings;
        }

        function applySiteSettings(settings) {
            if (!settings) return;
            
            // Применяем цвет фона
            document.body.style.backgroundColor = settings.backgroundColor;
            
            // Применяем цвет текста
            const color = settings.textColor;
            document.body.style.color = color;
            
            // Применяем цвет к карточкам
            const cards = document.querySelectorAll('.card');
            cards.forEach(card => {
                if (!card.closest('header')) {
                    card.style.color = color;
                }
            });
            
            // Применяем цвет к footer
            const footer = document.querySelector('footer');
            if (footer) {
                footer.style.color = color;
            }
            
            // Применяем цвет к заголовкам
            const headings = document.querySelectorAll('h2, h3, h4, h5, h6');
            headings.forEach(heading => {
                if (!heading.closest('header')) {
                    heading.style.color = color;
                }
            });
            
            // Применяем цвет к параграфам
            const paragraphs = document.querySelectorAll('p');
            paragraphs.forEach(p => {
                if (!p.closest('header')) {
                    p.style.color = color;
                }
            });
            
            // Применяем цвет к labels
            const labels = document.querySelectorAll('label');
            labels.forEach(label => {
                if (!label.closest('header')) {
                    label.style.color = color;
                }
            });
            
            // Применяем снег, если включен
            if (settings.snowEnabled) {
                startSnow(settings.snowIntensity, settings.snowColor);
            } else {
                stopSnow();
            }
        }

        function updateSiteSettingsForm(settings) {
            if (!settings || !backgroundColorPicker) return;
            
            // Заполняем поля формы
            backgroundColorPicker.value = settings.backgroundColor;
            backgroundColorHex.value = settings.backgroundColor;
            backgroundColorPreview.style.backgroundColor = settings.backgroundColor;
            currentColorSpan.textContent = settings.backgroundColor;
            
            textColorPicker.value = settings.textColor;
            textColorHex.value = settings.textColor;
            textColorPreview.style.backgroundColor = settings.textColor;
            currentTextColorSpan.textContent = settings.textColor;
            
            enableSnowCheckbox.checked = settings.snowEnabled;
            snowIntensitySlider.value = settings.snowIntensity;
            snowIntensityValue.textContent = settings.snowIntensity;
            snowColorPicker.value = settings.snowColor;
            
            // Обновляем выбранные цвета в сетке
            updateSelectedColorInGrid(settings.backgroundColor, colorOptions, 'data-color');
            updateSelectedColorInGrid(settings.textColor, textColorOptions, 'data-text-color');
            
            // Обновляем предпросмотр снега
            if (settings.snowEnabled) {
                createSnowPreview();
            } else {
                clearSnowPreview();
            }
        }

        function initModal() {
            closeModalBtn.addEventListener('click', function() {
                questionModal.style.display = 'none';
            });

            modalCancelBtn.addEventListener('click', function() {
                questionModal.style.display = 'none';
            });

            window.addEventListener('click', function(event) {
                if (event.target === questionModal) {
                    questionModal.style.display = 'none';
                }
                if (event.target === lectureModal) {
                    lectureModal.style.display = 'none';
                }
                if (event.target === reviewLectureModal) {
                    reviewLectureModal.style.display = 'none';
                }
            });

            modalAddOptionBtn.addEventListener('click', addModalOption);
            modalSaveQuestionBtn.addEventListener('click', saveModalQuestion);
        }

        function initLectureModal() {
            closeLectureModalBtn.addEventListener('click', function() {
                lectureModal.style.display = 'none';
            });

            lectureCancelBtn.addEventListener('click', function() {
                lectureModal.style.display = 'none';
            });

            lectureSaveBtn.addEventListener('click', saveLecture);
            lectureSubmitBtn.addEventListener('click', submitLecture);

            createNewLectureBtn.addEventListener('click', function() {
                openLectureModalForCreate();
            });
        }

        function initReviewLectureModal() {
            closeReviewLectureModalBtn.addEventListener('click', function() {
                reviewLectureModal.style.display = 'none';
            });

            reviewLectureCancelBtn.addEventListener('click', function() {
                reviewLectureModal.style.display = 'none';
            });

            reviewLectureApproveBtn.addEventListener('click', function() {
                reviewLectureDecision.value = 'approved';
                reviewLecture();
            });

            reviewLectureRejectBtn.addEventListener('click', function() {
                reviewLectureDecision.value = 'rejected';
                reviewLecture();
            });
        }

        function initSiteSettings() {
            colorOptions.forEach(option => {
                option.addEventListener('click', function() {
                    colorOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    const color = this.getAttribute('data-color');
                    currentColorSpan.textContent = color;
                    
                    backgroundColorPicker.value = color;
                    backgroundColorHex.value = color;
                    backgroundColorPreview.style.backgroundColor = color;
                });
            });

            textColorOptions.forEach(option => {
                option.addEventListener('click', function() {
                    textColorOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    const color = this.getAttribute('data-text-color');
                    currentTextColorSpan.textContent = color;
                    
                    textColorPicker.value = color;
                    textColorHex.value = color;
                    textColorPreview.style.backgroundColor = color;
                });
            });

            snowIntensitySlider.addEventListener('input', function() {
                snowIntensityValue.textContent = this.value;
            });

            saveSiteSettingsBtn.addEventListener('click', saveSiteSettings);
            resetSiteSettingsBtn.addEventListener('click', resetSiteSettings);

            enableSnowCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    createSnowPreview();
                } else {
                    clearSnowPreview();
                }
            });

            snowIntensitySlider.addEventListener('input', function() {
                if (enableSnowCheckbox.checked) {
                    clearSnowPreview();
                    createSnowPreview();
                }
            });
            
            snowColorPicker.addEventListener('input', function() {
                if (enableSnowCheckbox.checked) {
                    clearSnowPreview();
                    createSnowPreview();
                }
            });
        }
        
        function initColorInputs() {
            backgroundColorPicker.addEventListener('input', function() {
                const color = this.value;
                backgroundColorHex.value = color;
                backgroundColorPreview.style.backgroundColor = color;
                currentColorSpan.textContent = color;
                updateSelectedColorInGrid(color, colorOptions, 'data-color');
            });
            
            backgroundColorHex.addEventListener('input', function() {
                let color = this.value.trim();
                if (color && color[0] !== '#') {
                    color = '#' + color;
                }
                if (/^#[0-9A-F]{6}$/i.test(color)) {
                    backgroundColorPicker.value = color;
                    backgroundColorPreview.style.backgroundColor = color;
                    currentColorSpan.textContent = color;
                    updateSelectedColorInGrid(color, colorOptions, 'data-color');
                }
            });
            
            textColorPicker.addEventListener('input', function() {
                const color = this.value;
                textColorHex.value = color;
                textColorPreview.style.backgroundColor = color;
                currentTextColorSpan.textContent = color;
                updateSelectedColorInGrid(color, textColorOptions, 'data-text-color');
            });
            
            textColorHex.addEventListener('input', function() {
                let color = this.value.trim();
                if (color && color[0] !== '#') {
                    color = '#' + color;
                }
                if (/^#[0-9A-F]{6}$/i.test(color)) {
                    textColorPicker.value = color;
                    textColorPreview.style.backgroundColor = color;
                    currentTextColorSpan.textContent = color;
                    updateSelectedColorInGrid(color, textColorOptions, 'data-text-color');
                }
            });
        }
        
        function updateSelectedColorInGrid(color, options, attributeName) {
            let foundInGrid = false;
            options.forEach(option => {
                if (option.getAttribute(attributeName) === color) {
                    option.classList.add('selected');
                    foundInGrid = true;
                } else {
                    option.classList.remove('selected');
                }
            });
            if (!foundInGrid) {
                options.forEach(option => option.classList.remove('selected'));
            }
        }

        async function saveSiteSettings() {
            const backgroundColor = backgroundColorHex.value.trim() || backgroundColorPicker.value;
            const textColor = textColorHex.value.trim() || textColorPicker.value;
            
            const hexColorRegex = /^#[0-9A-F]{6}$/i;
            
            if (!hexColorRegex.test(backgroundColor)) {
                alert('Пожалуйста, введите корректный HEX-код цвета фона (формат: #RRGGBB)');
                return;
            }
            
            if (!hexColorRegex.test(textColor)) {
                alert('Пожалуйста, введите корректный HEX-код цвета текста (формат: #RRGGBB)');
                return;
            }
            
            const snowEnabled = enableSnowCheckbox.checked;
            const snowIntensity = parseInt(snowIntensitySlider.value);
            const snowColor = snowColorPicker.value;
            
            const settings = {
                backgroundColor: backgroundColor,
                textColor: textColor,
                snowEnabled: snowEnabled,
                snowIntensity: snowIntensity,
                snowColor: snowColor,
                updatedAt: new Date().toISOString()
            };
            
            // Сохраняем в Firebase
            if (firebaseConnected && firebaseHasPermission) {
                try {
                    await saveSiteSettingsToFirebase(settings);
                    console.log('✅ Настройки сайта сохранены в Firebase');
                } catch (error) {
                    console.error('❌ Ошибка сохранения настроек в Firebase:', error);
                    alert('Не удалось сохранить настройки в облаке. Они сохранены только локально.');
                }
            }
            
            // Сохраняем в localStorage
            localStorage.setItem('medicalTestSiteSettings', JSON.stringify(settings));
            
            // Обновляем текущие настройки
            currentSiteSettings = settings;
            
            // Применяем настройки
            applySiteSettings(settings);
            
            alert('Настройки сайта сохранены');
        }

        async function resetSiteSettings() {
            if (confirm('Вы уверены, что хотите сбросить настройки сайта к значениям по умолчанию?')) {
                const defaultSettings = {
                    backgroundColor: '#f5f7fa',
                    textColor: '#333333',
                    snowEnabled: false,
                    snowIntensity: 5,
                    snowColor: '#ffffff',
                    updatedAt: new Date().toISOString()
                };
                
                // Сбрасываем в Firebase
                if (firebaseConnected && firebaseHasPermission) {
                    try {
                        await saveSiteSettingsToFirebase(defaultSettings);
                        console.log('✅ Настройки сайта сброшены в Firebase');
                    } catch (error) {
                        console.error('❌ Ошибка сброса настроек в Firebase:', error);
                    }
                }
                
                // Сохраняем в localStorage
                localStorage.setItem('medicalTestSiteSettings', JSON.stringify(defaultSettings));
                
                // Обновляем текущие настройки
                currentSiteSettings = defaultSettings;
                
                // Применяем настройки
                applySiteSettings(defaultSettings);
                
                alert('Настройки сайта сброшены к значениям по умолчанию');
            }
        }

        function startSnow(intensity = 5, color = '#ffffff') {
            stopSnow();
            
            const snowContainer = document.getElementById('snow-container');
            if (!snowContainer) return;
            
            const snowflakeCount = intensity * 10;
            
            for (let i = 0; i < snowflakeCount; i++) {
                createSnowflake(snowContainer, color);
            }
            
            snowInterval = setInterval(() => {
                createSnowflake(snowContainer, color);
            }, 1000 / intensity);
        }

        function createSnowflake(container, color = '#ffffff') {
            const snowflake = document.createElement('div');
            snowflake.className = 'snowflake';
            snowflake.style.color = color;
            snowflake.style.fontSize = (Math.random() * 10 + 10) + 'px';
            snowflake.style.left = Math.random() * 100 + 'vw';
            snowflake.style.opacity = Math.random() * 0.5 + 0.3;
            
            container.appendChild(snowflake);
            
            const animationDuration = Math.random() * 10 + 10;
            snowflake.animate([
                { transform: 'translateY(0) rotate(0deg)', opacity: snowflake.style.opacity },
                { transform: `translateY(100vh) rotate(${Math.random() * 360}deg)`, opacity: 0 }
            ], {
                duration: animationDuration * 1000,
                easing: 'linear'
            });
            
            setTimeout(() => {
                if (snowflake.parentNode) {
                    snowflake.parentNode.removeChild(snowflake);
                }
            }, animationDuration * 1000);
        }

        function stopSnow() {
            if (snowInterval) {
                clearInterval(snowInterval);
                snowInterval = null;
            }
            
            const snowContainer = document.getElementById('snow-container');
            if (snowContainer) {
                snowContainer.innerHTML = '';
            }
        }

        function createSnowPreview() {
            clearSnowPreview();
            const previewContainer = snowPreview;
            const color = snowColorPicker.value;
            const intensity = parseInt(snowIntensitySlider.value);
            
            for (let i = 0; i < intensity * 3; i++) {
                const snowflake = document.createElement('div');
                snowflake.className = 'snowflake';
                snowflake.style.color = color;
                snowflake.style.fontSize = (Math.random() * 10 + 10) + 'px';
                snowflake.style.left = Math.random() * 100 + '%';
                snowflake.style.opacity = Math.random() * 0.5 + 0.3;
                
                previewContainer.appendChild(snowflake);
                
                const animationDuration = Math.random() * 5 + 3;
                snowflake.animate([
                    { transform: 'translateY(0) rotate(0deg)', opacity: snowflake.style.opacity },
                    { transform: `translateY(150px) rotate(${Math.random() * 360}deg)`, opacity: 0 }
                ], {
                    duration: animationDuration * 1000,
                    iterations: Infinity
                });
            }
        }

        function clearSnowPreview() {
            const previewContainer = snowPreview;
            previewContainer.innerHTML = '<p style="color: white; text-align: center; padding-top: 60px;">Предпросмотр снега</p>';
        }

        function initEventListeners() {
            // Переключение между панелями
            adminToggle.addEventListener('click', function() {
                userPanel.style.display = 'none';
                curatorPanel.style.display = 'none';
                commanderPanel.style.display = 'none';
                adminPanel.style.display = 'block';
                adminLogin.classList.remove('hidden');
                adminContent.classList.add('hidden');
                adminButtons.style.display = 'none';
                backToUserContainer.classList.remove('hidden');
                currentRole = null;
            });

            curatorToggle.addEventListener('click', function() {
                userPanel.style.display = 'none';
                adminPanel.style.display = 'none';
                commanderPanel.style.display = 'none';
                curatorPanel.style.display = 'block';
                curatorLogin.classList.remove('hidden');
                curatorContent.classList.add('hidden');
                adminButtons.style.display = 'none';
                backToUserContainerCurator.classList.remove('hidden');
                currentRole = null;
            });

            commanderToggle.addEventListener('click', function() {
                userPanel.style.display = 'none';
                adminPanel.style.display = 'none';
                curatorPanel.style.display = 'none';
                commanderPanel.style.display = 'block';
                commanderLogin.classList.remove('hidden');
                commanderContent.classList.add('hidden');
                adminButtons.style.display = 'none';
                backToUserContainerCommander.classList.remove('hidden');
                currentRole = null;
            });

            backToUserLoginBtn.addEventListener('click', function() {
                adminPanel.style.display = 'none';
                userPanel.style.display = 'block';
                showLoginSection();
                adminButtons.style.display = 'flex';
                currentRole = null;
            });

            backToUserLoginCuratorBtn.addEventListener('click', function() {
                curatorPanel.style.display = 'none';
                userPanel.style.display = 'block';
                showLoginSection();
                adminButtons.style.display = 'flex';
                currentRole = null;
            });

            backToUserLoginCommanderBtn.addEventListener('click', function() {
                commanderPanel.style.display = 'none';
                userPanel.style.display = 'block';
                showLoginSection();
                adminButtons.style.display = 'flex';
                currentRole = null;
            });

            userModeBtn.addEventListener('click', function() {
                adminPanel.style.display = 'none';
                userPanel.style.display = 'block';
                showLoginSection();
                adminButtons.style.display = 'flex';
                currentRole = null;
            });

            userModeCuratorBtn.addEventListener('click', function() {
                curatorPanel.style.display = 'none';
                userPanel.style.display = 'block';
                showLoginSection();
                adminButtons.style.display = 'flex';
                currentRole = null;
            });

            userModeCommanderBtn.addEventListener('click', function() {
                commanderPanel.style.display = 'none';
                userPanel.style.display = 'block';
                showLoginSection();
                adminButtons.style.display = 'flex';
                currentRole = null;
            });

            // Аутентификация администратора
            adminLoginBtn.addEventListener('click', async function() {
                const username = document.getElementById('admin-username').value;
                const password = document.getElementById('admin-password').value;
                await authenticateAdmin(username, password);
            });

            // Аутентификация куратора
            curatorLoginBtn.addEventListener('click', async function() {
                const username = document.getElementById('curator-username').value;
                const password = document.getElementById('curator-password').value;
                await authenticateCurator(username, password);
            });

            // Аутентификация коменданта
            commanderLoginBtn.addEventListener('click', async function() {
                const username = document.getElementById('commander-username').value;
                const password = document.getElementById('commander-password').value;
                await authenticateCommander(username, password);
            });

            adminLogoutBtn.addEventListener('click', function() {
                adminLogin.classList.remove('hidden');
                adminContent.classList.add('hidden');
                document.getElementById('admin-username').value = '';
                document.getElementById('admin-password').value = '';
                document.getElementById('admin-login-error').classList.add('hidden');
                adminButtons.style.display = 'flex';
                backToUserContainer.classList.remove('hidden');
                currentRole = null;
            });

            curatorLogoutBtn.addEventListener('click', function() {
                curatorLogin.classList.remove('hidden');
                curatorContent.classList.add('hidden');
                document.getElementById('curator-username').value = '';
                document.getElementById('curator-password').value = '';
                document.getElementById('curator-login-error').classList.add('hidden');
                adminButtons.style.display = 'flex';
                backToUserContainerCurator.classList.remove('hidden');
                currentRole = null;
            });

            commanderLogoutBtn.addEventListener('click', function() {
                commanderLogin.classList.remove('hidden');
                commanderContent.classList.add('hidden');
                document.getElementById('commander-username').value = '';
                document.getElementById('commander-password').value = '';
                document.getElementById('commander-login-error').classList.add('hidden');
                adminButtons.style.display = 'flex';
                backToUserContainerCommander.classList.remove('hidden');
                currentRole = null;
            });

            // Обычный пользователь
            loginBtn.addEventListener('click', function() {
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                authenticateUser(username, password);
            });

            logoutBtn.addEventListener('click', function() {
                currentUser = null;
                localStorage.removeItem('currentMedicalTestUser');
                showLoginSection();
                adminButtons.style.display = 'flex';
            });

            backToLoginBtn.addEventListener('click', function() {
                showLoginSection();
            });

            startSelectedTestBtn.addEventListener('click', function() {
                if (selectedAssignment) {
                    startSelectedTest();
                }
            });

            nextQuestionBtn.addEventListener('click', nextQuestion);
            submitTestBtn.addEventListener('click', submitTest);
            restartTestBtn.addEventListener('click', restartTest);

            // Вкладки в панели пользователя
            document.querySelectorAll('#test-selection-section .tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    document.querySelectorAll('#test-selection-section .tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('#test-selection-section .tab-content').forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                    
                    if (tabId === 'user-lectures') {
                        loadUserLectures();
                    }
                });
            });

            // Фильтр лекций пользователя
            document.getElementById('user-lecture-status').addEventListener('change', loadUserLectures);

            // Админ панель - вкладки
            document.querySelectorAll('#admin-content .tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    document.querySelectorAll('#admin-content .tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('#admin-content .tab-content').forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                    
                    if (tabId === 'users') {
                        loadUsersList();
                    } else if (tabId === 'platoons') {
                        loadPlatoonsList();
                    } else if (tabId === 'questions') {
                        loadQuestionSetsList();
                    } else if (tabId === 'assignments') {
                        loadAssignmentsList();
                    } else if (tabId === 'user-answers') {
                        loadUserAnswersList();
                    } else if (tabId === 'lectures') {
                        loadAdminLecturesList();
                    } else if (tabId === 'site-settings') {
                        updateSiteSettingsForm(currentSiteSettings);
                    }
                });
            });

            // Куратор панель - вкладки
            document.querySelectorAll('#curator-content .tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    document.querySelectorAll('#curator-content .tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('#curator-content .tab-content').forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                    
                    if (tabId === 'curator-users') {
                        loadUsersListForCurator();
                    } else if (tabId === 'curator-assignments') {
                        loadAssignmentsListForCurator();
                    } else if (tabId === 'curator-user-answers') {
                        loadUserAnswersListForCurator();
                    } else if (tabId === 'curator-lectures') {
                        loadCuratorLecturesList();
                    }
                });
            });

            // Комендант панель - вкладки
            document.querySelectorAll('#commander-content .tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    document.querySelectorAll('#commander-content .tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('#commander-content .tab-content').forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                    
                    if (tabId === 'commander-platoon') {
                        loadCommanderPlatoonInfo();
                    } else if (tabId === 'commander-lectures') {
                        loadCommanderLecturesList();
                    } else if (tabId === 'commander-lecture-assignments') {
                        loadCommanderLectureAssignments();
                    }
                });
            });

            // Админ панель - пользователи
            document.getElementById('add-user').addEventListener('click', addUser);
            document.getElementById('save-user').addEventListener('click', saveUserChanges);
            document.getElementById('cancel-user-edit').addEventListener('click', cancelUserEdit);

            // Куратор панель - пользователи
            document.getElementById('add-user-curator').addEventListener('click', addUserForCurator);
            document.getElementById('save-user-curator').addEventListener('click', saveUserChangesForCurator);
            document.getElementById('cancel-user-edit-curator').addEventListener('click', cancelUserEditForCurator);

            // Админ панель - взводы
            document.getElementById('add-platoon').addEventListener('click', addPlatoon);
            document.getElementById('save-platoon').addEventListener('click', savePlatoonChanges);
            document.getElementById('cancel-platoon-edit').addEventListener('click', cancelPlatoonEdit);

            // Админ панель - вопросы
            document.getElementById('add-question-set').addEventListener('click', addQuestionSet);
            document.getElementById('question-sets').addEventListener('change', loadQuestionsForSet);
            document.getElementById('add-question').addEventListener('click', addNewQuestion);
            document.getElementById('edit-question-set').addEventListener('click', editQuestionSet);
            document.getElementById('save-question-set').addEventListener('click', saveQuestionSetChanges);
            document.getElementById('cancel-set-edit').addEventListener('click', cancelSetEdit);

            // Админ панель - назначения
            document.getElementById('assign-test').addEventListener('click', assignTest);

            // Куратор панель - назначения
            document.getElementById('assign-test-curator').addEventListener('click', assignTestForCurator);

            // Комендант панель - назначения лекций
            document.getElementById('assign-lecture').addEventListener('click', assignLecture);

            // Фильтры админ панели
            document.getElementById('filter-unit').addEventListener('change', loadAssignmentsList);
            document.getElementById('filter-role').addEventListener('change', loadAssignmentsList);

            document.getElementById('filter-answers-unit').addEventListener('change', loadUserAnswersList);
            document.getElementById('filter-answers-role').addEventListener('change', loadUserAnswersList);
            document.getElementById('filter-answers-test').addEventListener('change', loadUserAnswersList);

            document.getElementById('admin-lecture-status').addEventListener('change', loadAdminLecturesList);
            document.getElementById('admin-lecture-platoon').addEventListener('change', loadAdminLecturesList);
            document.getElementById('admin-lecture-author').addEventListener('change', loadAdminLecturesList);

            // Фильтры куратор панели
            document.getElementById('filter-unit-curator').addEventListener('change', loadAssignmentsListForCurator);
            document.getElementById('filter-role-curator').addEventListener('change', loadAssignmentsListForCurator);

            document.getElementById('filter-answers-unit-curator').addEventListener('change', loadUserAnswersListForCurator);
            document.getElementById('filter-answers-role-curator').addEventListener('change', loadUserAnswersListForCurator);
            document.getElementById('filter-answers-test-curator').addEventListener('change', loadUserAnswersListForCurator);

            document.getElementById('curator-lecture-status').addEventListener('change', loadCuratorLecturesList);
            document.getElementById('curator-lecture-platoon').addEventListener('change', loadCuratorLecturesList);
            document.getElementById('curator-lecture-author').addEventListener('change', loadCuratorLecturesList);

            // Фильтры комендант панели
            document.getElementById('commander-lecture-status').addEventListener('change', loadCommanderLecturesList);
            document.getElementById('commander-lecture-author').addEventListener('change', loadCommanderLecturesList);

            if (hideFirebaseHelpBtn) {
                hideFirebaseHelpBtn.addEventListener('click', hideFirebaseHelp);
            }
        }

        function addModalOption() {
            const optionIndex = modalOptionsContainer.children.length;
            
            const optionEditor = document.createElement('div');
            optionEditor.className = 'option-editor';
            
            optionEditor.innerHTML = `
                <input type="text" class="modal-option-input" placeholder="Вариант ответа ${optionIndex + 1}">
                <button class="btn btn-danger remove-modal-option" type="button">×</button>
            `;
            
            modalOptionsContainer.appendChild(optionEditor);
            
            updateModalCorrectAnswerOptions();
            
            optionEditor.querySelector('.remove-modal-option').addEventListener('click', function() {
                optionEditor.remove();
                updateModalCorrectAnswerOptions();
            });
        }

        function updateModalCorrectAnswerOptions() {
            const options = document.querySelectorAll('.modal-option-input');
            
            modalCorrectAnswer.innerHTML = '<option value="">-- Выберите правильный ответ --</option>';
            
            options.forEach((optionInput, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = optionInput.value || `Вариант ${index + 1}`;
                modalCorrectAnswer.appendChild(option);
            });
        }

        async function authenticateAdmin(username, password) {
            try {
                const users = await loadUsers();
                const admin = users.find(u => u.login === username && u.password === password && u.role === 'admin');
                
                if (admin) {
                    adminLogin.classList.add('hidden');
                    adminContent.classList.remove('hidden');
                    document.getElementById('admin-login-error').classList.add('hidden');
                    backToUserContainer.classList.add('hidden');
                    currentRole = 'admin';
                    await loadAdminData();
                } else {
                    document.getElementById('admin-login-error').classList.remove('hidden');
                }
            } catch (error) {
                console.error('❌ Ошибка аутентификации администратора:', error);
                document.getElementById('admin-login-error').classList.remove('hidden');
            }
        }

        async function authenticateCurator(username, password) {
            try {
                const users = await loadUsers();
                const curator = users.find(u => u.login === username && u.password === password && u.role === 'curator');
                
                if (curator) {
                    curatorLogin.classList.add('hidden');
                    curatorContent.classList.remove('hidden');
                    document.getElementById('curator-login-error').classList.add('hidden');
                    backToUserContainerCurator.classList.add('hidden');
                    currentRole = 'curator';
                    await loadCuratorData();
                } else {
                    document.getElementById('curator-login-error').classList.remove('hidden');
                }
            } catch (error) {
                console.error('❌ Ошибка аутентификации куратора:', error);
                document.getElementById('curator-login-error').classList.remove('hidden');
            }
        }

        async function authenticateCommander(username, password) {
            try {
                const users = await loadUsers();
                const commander = users.find(u => u.login === username && u.password === password && u.role === 'commander');
                
                if (commander) {
                    commanderLogin.classList.add('hidden');
                    commanderContent.classList.remove('hidden');
                    document.getElementById('commander-login-error').classList.add('hidden');
                    backToUserContainerCommander.classList.add('hidden');
                    currentRole = 'commander';
                    currentUser = commander;
                    await loadCommanderData();
                } else {
                    document.getElementById('commander-login-error').classList.remove('hidden');
                }
            } catch (error) {
                console.error('❌ Ошибка аутентификации коменданта:', error);
                document.getElementById('commander-login-error').classList.remove('hidden');
            }
        }

        async function authenticateUser(username, password) {
            try {
                const users = await loadUsers();
                const user = users.find(u => u.login === username && u.password === password);
                
                if (user) {
                    currentUser = user;
                    localStorage.setItem('currentMedicalTestUser', JSON.stringify(user));
                    document.getElementById('login-error').classList.add('hidden');
                    document.getElementById('no-assignment-error').classList.add('hidden');
                    await loadUserData();
                } else {
                    document.getElementById('login-error').classList.remove('hidden');
                    document.getElementById('no-assignment-error').classList.add('hidden');
                }
            } catch (error) {
                console.error('❌ Ошибка аутентификации:', error);
                document.getElementById('login-error').classList.remove('hidden');
                document.getElementById('no-assignment-error').classList.add('hidden');
            }
        }

        async function loadUserData() {
            await loadUserAssignments();
            
            // Показываем информацию о взводе если пользователь в нем
            if (currentUser.platoonId) {
                const platoons = await loadPlatoons();
                const platoon = platoons.find(p => p.id === currentUser.platoonId);
                if (platoon) {
                    currentPlatoonInfo.style.display = 'block';
                    currentPlatoon.textContent = platoon.name;
                }
            }
        }

        async function loadUserAssignments() {
            try {
                const assignments = await loadAssignments();
                const userAnswers = await loadUserAnswers();
                const userAssignments = assignments.filter(a => a.userId === currentUser.id);
                
                if (userAssignments.length === 0 && currentUser.role !== 'commander' && currentUser.role !== 'curator' && currentUser.role !== 'admin') {
                    document.getElementById('no-assignment-error').classList.remove('hidden');
                    document.getElementById('no-assignment-error').textContent = 'Для вашего аккаунта не назначен тест. Обратитесь к администратору.';
                } else {
                    document.getElementById('no-assignment-error').classList.add('hidden');
                }
                
                const questionSets = await loadQuestionSets();
                const availableTests = [];
                const completedTests = [];
                
                for (const assignment of userAssignments) {
                    const questionSet = questionSets.find(qs => qs.id === assignment.questionSetId);
                    if (questionSet) {
                        const existingAnswer = userAnswers.find(ua => 
                            ua.userId === currentUser.id && 
                            ua.questionSetId === questionSet.id
                        );
                        
                        if (existingAnswer) {
                            completedTests.push({
                                assignment: assignment,
                                questionSet: questionSet,
                                userAnswer: existingAnswer
                            });
                        } else {
                            availableTests.push({
                                assignment: assignment,
                                questionSet: questionSet
                            });
                        }
                    }
                }
                
                if (availableTests.length > 0 || completedTests.length > 0 || currentUser.role === 'commander' || currentUser.role === 'curator' || currentUser.role === 'admin') {
                    showTestSelection(availableTests, completedTests);
                }
                
            } catch (error) {
                console.error('❌ Ошибка загрузки назначений:', error);
                document.getElementById('no-assignment-error').classList.remove('hidden');
                document.getElementById('no-assignment-error').textContent = 'Ошибка загрузки назначений.';
            }
        }

        function showTestSelection(availableTests, completedTests = []) {
            availableTestsContainer.innerHTML = '';
            selectedAssignment = null;
            startSelectedTestBtn.style.display = 'none';
            
            if (completedTests.length > 0) {
                const completedInfo = document.createElement('div');
                completedInfo.className = 'test-completed-info';
                completedInfo.innerHTML = `
                    <h3>Пройденные тесты</h3>
                    <p>Вы уже прошли следующие тесты. Повторное прохождение недоступно.</p>
                `;
                availableTestsContainer.appendChild(completedInfo);
                
                completedTests.forEach((test, index) => {
                    const testOption = document.createElement('div');
                    testOption.className = 'test-option completed';
                    testOption.setAttribute('data-index', index);
                    
                    testOption.innerHTML = `
                        <div class="completed-badge">Пройден</div>
                        <h3>${test.questionSet.name}</h3>
                        <p>${test.questionSet.questions ? test.questionSet.questions.length : 0} вопросов</p>
                        <div class="test-info">
                            <span>Результат: ${test.userAnswer.score}/${test.userAnswer.totalQuestions} (${test.userAnswer.percentage}%)</span>
                            <span>Пройден: ${new Date(test.userAnswer.timestamp).toLocaleDateString('ru-RU')}</span>
                        </div>
                    `;
                    
                    availableTestsContainer.appendChild(testOption);
                });
            }
            
            if (availableTests.length > 0) {
                if (completedTests.length > 0) {
                    const availableHeader = document.createElement('h3');
                    availableHeader.textContent = 'Доступные тесты';
                    availableHeader.style.marginTop = '20px';
                    availableHeader.style.marginBottom = '10px';
                    availableTestsContainer.appendChild(availableHeader);
                }
                
                availableTests.forEach((test, index) => {
                    const testOption = document.createElement('div');
                    testOption.className = 'test-option';
                    testOption.setAttribute('data-index', index);
                    
                    testOption.innerHTML = `
                        <h3>${test.questionSet.name}</h3>
                        <p>${test.questionSet.questions ? test.questionSet.questions.length : 0} вопросов</p>
                        <div class="test-info">
                            <span>Время: ${test.questionSet.totalTime || 30} мин.</span>
                            <span>Назначен: ${new Date(test.assignment.assignedAt).toLocaleDateString('ru-RU')}</span>
                        </div>
                    `;
                    
                    testOption.addEventListener('click', function() {
                        document.querySelectorAll('.test-option:not(.completed)').forEach(opt => {
                            opt.classList.remove('selected');
                        });
                        this.classList.add('selected');
                        selectedAssignment = test;
                        startSelectedTestBtn.style.display = 'block';
                    });
                    
                    availableTestsContainer.appendChild(testOption);
                });
            }
            
            if (availableTests.length === 0 && completedTests.length > 0) {
                const noAvailableMessage = document.createElement('div');
                noAvailableMessage.className = 'test-completed-info';
                noAvailableMessage.innerHTML = `
                    <p>Все назначенные вам тесты уже пройдены. Обратитесь к администратору для получения новых тестов.</p>
                `;
                availableTestsContainer.appendChild(noAvailableMessage);
            }
            
            if (availableTests.length === 0 && completedTests.length === 0) {
                availableTestsContainer.innerHTML = '<p>Нет доступных тестов</p>';
            }
            
            showTestSelectionSection();
        }

        function startSelectedTest() {
            if (!selectedAssignment) {
                alert('Пожалуйста, выберите тест для начала');
                return;
            }
            
            currentQuestionSet = selectedAssignment.questionSet;
            totalTime = (currentQuestionSet.totalTime || 30) * 60;
            
            currentQuestionIndex = 0;
            userAnswers = [];
            
            startTest();
            showTestSection();
        }

        function showLoginSection() {
            loginSection.style.display = 'block';
            testSelectionSection.style.display = 'none';
            testSection.style.display = 'none';
            resultsSection.style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('login-error').classList.add('hidden');
            document.getElementById('no-assignment-error').classList.add('hidden');
            adminButtons.style.display = 'flex';
        }

        function showTestSelectionSection() {
            loginSection.style.display = 'none';
            testSelectionSection.style.display = 'block';
            testSection.style.display = 'none';
            resultsSection.style.display = 'none';
            adminButtons.style.display = 'none';
        }

        function showTestSection() {
            loginSection.style.display = 'none';
            testSelectionSection.style.display = 'none';
            testSection.style.display = 'block';
            resultsSection.style.display = 'none';
            adminButtons.style.display = 'none';
        }

        function showResultsSection() {
            loginSection.style.display = 'none';
            testSelectionSection.style.display = 'none';
            testSection.style.display = 'none';
            resultsSection.style.display = 'block';
            adminButtons.style.display = 'flex';
        }

        function startTest() {
            currentQuestionIndex = 0;
            userAnswers = [];
            remainingQuestionTime = 0;
            startTimer();
            displayQuestion();
        }

        function startTimer() {
            clearInterval(timerInterval);
            clearInterval(questionTimerInterval);
            
            let timeLeft = totalTime;
            
            timerInterval = setInterval(function() {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                
                timerElement.textContent = `Общее время: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (timeLeft <= 300) {
                    timerElement.classList.add('warning');
                }
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    clearInterval(questionTimerInterval);
                    timeExpired();
                }
                
                timeLeft--;
            }, 1000);
        }

        function timeExpired() {
            const timeExpiredMessage = document.createElement('div');
            timeExpiredMessage.className = 'time-expired';
            timeExpiredMessage.innerHTML = '<h3>Время вышло!</h3><p>Тест автоматически завершен.</p>';
            
            questionsContainer.innerHTML = '';
            questionsContainer.appendChild(timeExpiredMessage);
            
            submitTest();
        }

        function displayQuestion() {
            if (!currentQuestionSet || !currentQuestionSet.questions) {
                console.error('❌ Набор вопросов не загружен');
                return;
            }
            
            if (currentQuestionIndex >= currentQuestionSet.questions.length) {
                submitTest();
                return;
            }
            
            const question = currentQuestionSet.questions[currentQuestionIndex];
            questionsContainer.innerHTML = '';
            
            questionCounterElement.textContent = `Вопрос ${currentQuestionIndex + 1} из ${currentQuestionSet.questions.length}`;
            
            const questionElement = document.createElement('div');
            questionElement.className = 'question';
            
            const questionText = document.createElement('div');
            questionText.className = 'question-text preserve-formatting';
            questionText.textContent = question.text;
            questionElement.appendChild(questionText);
            
            const optionsContainer = document.createElement('div');
            optionsContainer.className = 'options';
            
            question.options.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'option';
                
                const optionInput = document.createElement('input');
                optionInput.type = 'radio';
                optionInput.name = 'question-option';
                optionInput.value = index;
                optionInput.id = `option-${index}`;
                
                const optionLabel = document.createElement('label');
                optionLabel.htmlFor = `option-${index}`;
                optionLabel.textContent = option;
                
                optionElement.appendChild(optionInput);
                optionElement.appendChild(optionLabel);
                
                optionElement.addEventListener('click', function() {
                    document.querySelectorAll('.option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    optionElement.classList.add('selected');
                    optionInput.checked = true;
                    
                    userAnswers[currentQuestionIndex] = index;
                });
                
                optionsContainer.appendChild(optionElement);
            });
            
            questionElement.appendChild(optionsContainer);
            questionsContainer.appendChild(questionElement);
            
            if (userAnswers[currentQuestionIndex] !== undefined) {
                const selectedOption = document.querySelector(`input[value="${userAnswers[currentQuestionIndex]}"]`);
                if (selectedOption) {
                    selectedOption.checked = true;
                    selectedOption.parentElement.classList.add('selected');
                }
            }
            
            nextQuestionBtn.style.display = currentQuestionIndex < currentQuestionSet.questions.length - 1 ? 'block' : 'none';
            submitTestBtn.style.display = currentQuestionIndex === currentQuestionSet.questions.length - 1 ? 'block' : 'none';
            
            startQuestionTimer(question.time || questionTime);
        }

        function startQuestionTimer(time) {
            clearInterval(questionTimerInterval);
            
            remainingQuestionTime = time;
            updateQuestionTimerDisplay();
            
            questionTimerInterval = setInterval(function() {
                remainingQuestionTime--;
                updateQuestionTimerDisplay();
                
                if (remainingQuestionTime <= 0) {
                    clearInterval(questionTimerInterval);
                    nextQuestion();
                }
            }, 1000);
        }

        function updateQuestionTimerDisplay() {
            const minutes = Math.floor(remainingQuestionTime / 60);
            const seconds = remainingQuestionTime % 60;
            questionTimerElement.textContent = `Время на вопрос: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            if (remainingQuestionTime <= 10) {
                questionTimerElement.classList.add('warning');
            } else {
                questionTimerElement.classList.remove('warning');
            }
        }

        function nextQuestion() {
            currentQuestionIndex++;
            displayQuestion();
        }

        async function submitTest() {
            clearInterval(timerInterval);
            clearInterval(questionTimerInterval);
            
            const results = calculateResults();
            await saveUserAnswers(results);
            displayResults(results);
            showResultsSection();
        }

        function calculateResults() {
            if (!currentQuestionSet || !currentQuestionSet.questions) {
                return {
                    score: 0,
                    correctAnswers: 0,
                    totalQuestions: 0,
                    percentage: 0
                };
            }
            
            let correctAnswers = 0;
            const totalQuestions = currentQuestionSet.questions.length;
            
            const results = {
                userId: currentUser.id,
                userName: currentUser.login,
                userUnit: currentUser.unit || 'none',
                userRole: currentUser.role,
                userPlatoonId: currentUser.platoonId || '',
                questionSetId: currentQuestionSet.id,
                questionSetName: currentQuestionSet.name,
                excellentScore: currentQuestionSet.excellentScore || 80,
                assignmentId: selectedAssignment ? selectedAssignment.assignment.id : null,
                answers: [],
                score: 0,
                correctAnswers: 0,
                totalQuestions: totalQuestions,
                percentage: 0,
                timestamp: new Date().toISOString()
            };
            
            currentQuestionSet.questions.forEach((question, index) => {
                const userAnswer = userAnswers[index];
                const isCorrect = userAnswer === question.correctAnswer;
                
                if (isCorrect) {
                    correctAnswers++;
                }
                
                results.answers.push({
                    question: question.text,
                    userAnswer: userAnswer !== undefined ? question.options[userAnswer] : 'Не отвечено',
                    correctAnswer: question.options[question.correctAnswer],
                    isCorrect: isCorrect,
                    isAnswered: userAnswer !== undefined
                });
            });
            
            results.correctAnswers = correctAnswers;
            results.score = correctAnswers;
            results.percentage = Math.round((correctAnswers / totalQuestions) * 100);
            
            return results;
        }

        async function saveUserAnswers(results) {
            try {
                const userAnswer = {
                    userId: currentUser.id,
                    userName: currentUser.login,
                    userUnit: currentUser.unit || 'none',
                    userRole: currentUser.role,
                    userPlatoonId: currentUser.platoonId || '',
                    questionSetId: currentQuestionSet.id,
                    questionSetName: currentQuestionSet.name,
                    answers: results.answers,
                    score: results.score,
                    totalQuestions: results.totalQuestions,
                    percentage: results.percentage,
                    excellentScore: results.excellentScore,
                    timestamp: new Date().toISOString(),
                    mskTime: getMoscowTime()
                };
                
                await saveUserAnswer(userAnswer);
                console.log('✅ Ответы пользователя сохранены');
            } catch (error) {
                console.error('❌ Ошибка сохранения ответов пользователя:', error);
            }
        }

        function getMoscowTime() {
            const now = new Date();
            const mskOffset = 3 * 60;
            const localOffset = now.getTimezoneOffset();
            const mskTime = new Date(now.getTime() + (mskOffset + localOffset) * 60000);
            
            return mskTime.toLocaleString('ru-RU', {
                timeZone: 'Europe/Moscow',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        function displayResults(results) {
            currentUserElement.textContent = currentUser.login;
            currentUnitElement.textContent = getUnitDisplayName(currentUser.unit || 'none');
            
            // Показываем информацию о взводе если пользователь в нем
            if (currentUser.platoonId) {
                currentPlatoonInfo.style.display = 'block';
                loadPlatoons().then(platoons => {
                    const platoon = platoons.find(p => p.id === currentUser.platoonId);
                    if (platoon) {
                        currentPlatoon.textContent = platoon.name;
                    }
                });
            }
            
            scoreElement.textContent = `${results.score} из ${results.totalQuestions}`;
            
            if (results.percentage >= results.excellentScore) {
                resultMessageElement.textContent = 'Отличный результат!';
            } else if (results.percentage >= 60) {
                resultMessageElement.textContent = 'Хороший результат!';
            } else {
                resultMessageElement.textContent = 'Вам нужно больше практики.';
            }
            
            resultsSummaryElement.innerHTML = `
                <div class="summary-item">
                    <div class="summary-value">${results.percentage}%</div>
                    <div class="summary-label">Правильных ответов</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value">${results.correctAnswers}</div>
                    <div class="summary-label">Правильных</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value">${results.totalQuestions - results.correctAnswers}</div>
                    <div class="summary-label">Неправильных</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value">${results.excellentScore}%</div>
                    <div class="summary-label">Для "отлично"</div>
                </div>
            `;
            
            resultsDetailsElement.innerHTML = '';
            
            results.answers.forEach((answer, index) => {
                const resultItem = document.createElement('div');
                
                if (answer.isCorrect) {
                    resultItem.className = 'result-item correct';
                } else if (answer.isAnswered) {
                    resultItem.className = 'result-item incorrect';
                } else {
                    resultItem.className = 'result-item unanswered';
                }
                
                const userAnswerClass = answer.isCorrect ? 'user-answer correct' : 'user-answer';
                
                let answerHtml = `
                    <div class="result-question preserve-formatting">${index + 1}. ${answer.question}</div>
                    <div class="result-answer">Ваш ответ: <span class="${userAnswerClass}">${answer.userAnswer}</span></div>
                `;
                
                if (!answer.isCorrect) {
                    answerHtml += `<div class="result-answer">Правильный ответ: <span class="correct-answer">${answer.correctAnswer}</span></div>`;
                }
                
                if (!answer.isAnswered) {
                    answerHtml += `<div class="result-answer">Вы не ответили на этот вопрос</div>`;
                }
                
                resultItem.innerHTML = answerHtml;
                resultsDetailsElement.appendChild(resultItem);
            });
            
            restartTestBtn.classList.add('hidden');
        }

        function restartTest() {
            showTestSelectionSection();
        }

        async function loadAdminData() {
            await loadUsersList();
            await loadPlatoonsList();
            await loadQuestionSetsList();
            await loadAssignmentsList();
            await loadUserAnswersList();
            await loadAdminLecturesList();
        }

        async function loadCuratorData() {
            await loadUsersListForCurator();
            await loadQuestionSetsListForCurator();
            await loadAssignmentsListForCurator();
            await loadUserAnswersListForCurator();
            await loadCuratorLecturesList();
        }

        async function loadCommanderData() {
            await loadCommanderPlatoonInfo();
            await loadCommanderLecturesList();
            await loadCommanderLectureAssignments();
        }

        // ============================================
        // СИСТЕМА ЛЕКЦИЙ
        // ============================================

        async function loadUserLectures() {
            try {
                const lectures = await loadLectures();
                const userLecturesList = document.getElementById('user-lectures-list');
                userLecturesList.innerHTML = '';
                
                const statusFilter = document.getElementById('user-lecture-status').value;
                
                // Фильтруем лекции текущего пользователя
                let userLectures = lectures.filter(l => l.userId === currentUser.id);
                
                if (statusFilter) {
                    userLectures = userLectures.filter(l => l.status === statusFilter);
                }
                
                // Сортируем по дате создания (новые сверху)
                userLectures.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                if (userLectures.length === 0) {
                    userLecturesList.innerHTML = '<p>У вас пока нет лекций</p>';
                    return;
                }
                
                userLectures.forEach(lecture => {
                    const lectureItem = document.createElement('div');
                    lectureItem.className = 'lecture-item';
                    
                    lectureItem.innerHTML = `
                        <div class="lecture-header">
                            <div>
                                <strong>${lecture.topic}</strong>
                                <span class="lecture-status ${getLectureStatusClass(lecture.status)}">${getLectureStatusDisplayName(lecture.status)}</span>
                            </div>
                            <div class="lecture-actions">
                                ${lecture.status === 'draft' ? `<button class="btn btn-warning edit-lecture" data-id="${lecture.id}">Редактировать</button>` : ''}
                                ${lecture.status === 'draft' ? `<button class="btn btn-success submit-lecture" data-id="${lecture.id}">Отправить на проверку</button>` : ''}
                                ${lecture.status === 'rejected' ? `<button class="btn btn-warning edit-lecture" data-id="${lecture.id}">Переписать</button>` : ''}
                                <button class="btn btn-info view-lecture" data-id="${lecture.id}">Просмотреть</button>
                                ${lecture.status === 'draft' || lecture.status === 'rejected' ? `<button class="btn btn-danger delete-lecture" data-id="${lecture.id}">Удалить</button>` : ''}
                            </div>
                        </div>
                        <div class="lecture-info">
                            <div>Создано: ${new Date(lecture.createdAt).toLocaleString('ru-RU')}</div>
                            ${lecture.updatedAt ? `<div>Обновлено: ${new Date(lecture.updatedAt).toLocaleString('ru-RU')}</div>` : ''}
                            ${lecture.reviewedAt ? `<div>Проверено: ${new Date(lecture.reviewedAt).toLocaleString('ru-RU')}</div>` : ''}
                            ${lecture.reviewedBy ? `<div>Проверил: ${lecture.reviewedByName || 'Комендант'}</div>` : ''}
                            ${lecture.commanderNotes ? `<div class="commander-notes"><strong>Заметки коменданта:</strong> ${lecture.commanderNotes}</div>` : ''}
                        </div>
                        <div class="lecture-content" style="max-height: 100px;">
                            ${lecture.content.substring(0, 200)}${lecture.content.length > 200 ? '...' : ''}
                        </div>
                    `;
                    
                    userLecturesList.appendChild(lectureItem);
                });
                
                // Добавляем обработчики событий
                userLecturesList.querySelectorAll('.edit-lecture').forEach(button => {
                    button.addEventListener('click', function() {
                        const lectureId = this.getAttribute('data-id');
                        openLectureModalForEdit(lectureId);
                    });
                });
                
                userLecturesList.querySelectorAll('.submit-lecture').forEach(button => {
                    button.addEventListener('click', function() {
                        const lectureId = this.getAttribute('data-id');
                        submitLectureById(lectureId);
                    });
                });
                
                userLecturesList.querySelectorAll('.view-lecture').forEach(button => {
                    button.addEventListener('click', function() {
                        const lectureId = this.getAttribute('data-id');
                        viewLecture(lectureId);
                    });
                });
                
                userLecturesList.querySelectorAll('.delete-lecture').forEach(button => {
                    button.addEventListener('click', function() {
                        const lectureId = this.getAttribute('data-id');
                        deleteLectureById(lectureId);
                    });
                });
                
            } catch (error) {
                console.error('❌ Ошибка загрузки лекций пользователя:', error);
                document.getElementById('user-lectures-list').innerHTML = '<p>Ошибка при загрузке лекций</p>';
            }
        }

        function openLectureModalForCreate() {
            currentLectureModalMode = 'create';
            currentEditingLectureId = null;
            
            lectureModalTitle.textContent = 'Создание новой лекции';
            lectureTopic.value = '';
            lectureContent.value = '';
            lectureStatus.value = 'draft';
            lectureNotesSection.style.display = 'none';
            lectureNotes.value = '';
            
            // Показываем кнопки сохранения и отправки
            lectureSaveBtn.style.display = 'inline-block';
            lectureSubmitBtn.style.display = 'inline-block';
            
            // Делаем поля редактируемыми
            lectureTopic.disabled = false;
            lectureContent.disabled = false;
            
            lectureModal.style.display = 'block';
        }

        async function openLectureModalForEdit(lectureId) {
            try {
                const lectures = await loadLectures();
                const lecture = lectures.find(l => l.id === lectureId);
                
                if (!lecture) {
                    alert('Лекция не найдена');
                    return;
                }
                
                // Проверяем, может ли пользователь редактировать эту лекцию
                if (lecture.userId !== currentUser.id) {
                    alert('Вы не можете редактировать эту лекцию');
                    return;
                }
                
                // Проверяем статус лекции
                if (lecture.status !== 'draft' && lecture.status !== 'rejected') {
                    alert('Вы можете редактировать только черновики и отклоненные лекции');
                    return;
                }
                
                currentLectureModalMode = 'edit';
                currentEditingLectureId = lectureId;
                
                lectureModalTitle.textContent = 'Редактирование лекции';
                lectureTopic.value = lecture.topic;
                lectureContent.value = lecture.content;
                lectureStatus.value = lecture.status;
                
                // Показываем заметки коменданта если они есть
                if (lecture.commanderNotes) {
                    lectureNotesSection.style.display = 'block';
                    lectureNotes.value = lecture.commanderNotes;
                } else {
                    lectureNotesSection.style.display = 'none';
                }
                
                // Показываем кнопки сохранения и отправки
                lectureSaveBtn.style.display = 'inline-block';
                lectureSubmitBtn.style.display = 'inline-block';
                
                // Делаем поля редактируемыми
                lectureTopic.disabled = false;
                lectureContent.disabled = false;
                
                lectureModal.style.display = 'block';
                
            } catch (error) {
                console.error('❌ Ошибка открытия лекции для редактирования:', error);
                alert('Ошибка при загрузке лекции');
            }
        }

        function viewLecture(lectureId) {
            loadLectures().then(lectures => {
                const lecture = lectures.find(l => l.id === lectureId);
                
                if (!lecture) {
                    alert('Лекция не найдена');
                    return;
                }
                
                currentLectureModalMode = 'view';
                currentEditingLectureId = lectureId;
                
                lectureModalTitle.textContent = 'Просмотр лекции';
                lectureTopic.value = lecture.topic;
                lectureContent.value = lecture.content;
                lectureStatus.value = lecture.status;
                
                // Показываем заметки коменданта если они есть
                if (lecture.commanderNotes) {
                    lectureNotesSection.style.display = 'block';
                    lectureNotes.value = lecture.commanderNotes;
                } else {
                    lectureNotesSection.style.display = 'none';
                }
                
                // Скрываем кнопки сохранения и отправки
                lectureSaveBtn.style.display = 'none';
                lectureSubmitBtn.style.display = 'none';
                
                // Делаем поля только для чтения
                lectureTopic.disabled = true;
                lectureContent.disabled = true;
                
                lectureModal.style.display = 'block';
            });
        }

        async function saveLecture() {
            const topic = lectureTopic.value.trim();
            const content = lectureContent.value.trim();
            
            if (!topic) {
                alert('Введите тему лекции');
                return;
            }
            
            if (!content) {
                alert('Введите содержание лекции');
                return;
            }
            
            try {
                let lecture;
                
                if (currentLectureModalMode === 'create') {
                    // Создаем новую лекцию
                    lecture = {
                        userId: currentUser.id,
                        userName: currentUser.login,
                        userPlatoonId: currentUser.platoonId || '',
                        topic: topic,
                        content: content,
                        status: 'draft',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                } else if (currentLectureModalMode === 'edit') {
                    // Обновляем существующую лекцию
                    const lectures = await loadLectures();
                    const existingLecture = lectures.find(l => l.id === currentEditingLectureId);
                    
                    if (!existingLecture) {
                        alert('Лекция не найдена');
                        return;
                    }
                    
                    lecture = {
                        ...existingLecture,
                        topic: topic,
                        content: content,
                        updatedAt: new Date().toISOString()
                    };
                }
                
                await saveLecture(lecture);
                
                lectureModal.style.display = 'none';
                await loadUserLectures();
                
                alert('Лекция сохранена');
                
            } catch (error) {
                console.error('❌ Ошибка сохранения лекции:', error);
                alert('Ошибка при сохранении лекции');
            }
        }

        async function submitLecture() {
            const topic = lectureTopic.value.trim();
            const content = lectureContent.value.trim();
            
            if (!topic) {
                alert('Введите тему лекции');
                return;
            }
            
            if (!content) {
                alert('Введите содержание лекции');
                return;
            }
            
            try {
                let lecture;
                
                if (currentLectureModalMode === 'create') {
                    // Создаем новую лекцию и сразу отправляем на проверку
                    lecture = {
                        userId: currentUser.id,
                        userName: currentUser.login,
                        userPlatoonId: currentUser.platoonId || '',
                        topic: topic,
                        content: content,
                        status: 'pending',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString(),
                        submittedAt: new Date().toISOString()
                    };
                } else if (currentLectureModalMode === 'edit') {
                    // Обновляем существующую лекцию и отправляем на проверку
                    const lectures = await loadLectures();
                    const existingLecture = lectures.find(l => l.id === currentEditingLectureId);
                    
                    if (!existingLecture) {
                        alert('Лекция не найдена');
                        return;
                    }
                    
                    lecture = {
                        ...existingLecture,
                        topic: topic,
                        content: content,
                        status: 'pending',
                        updatedAt: new Date().toISOString(),
                        submittedAt: new Date().toISOString()
                    };
                }
                
                await saveLecture(lecture);
                
                lectureModal.style.display = 'none';
                await loadUserLectures();
                
                alert('Лекция отправлена на проверку коменданту');
                
            } catch (error) {
                console.error('❌ Ошибка отправки лекции:', error);
                alert('Ошибка при отправке лекции');
            }
        }

        async function submitLectureById(lectureId) {
            try {
                const lectures = await loadLectures();
                const lecture = lectures.find(l => l.id === lectureId);
                
                if (!lecture) {
                    alert('Лекция не найдена');
                    return;
                }
                
                // Обновляем статус лекции
                lecture.status = 'pending';
                lecture.updatedAt = new Date().toISOString();
                lecture.submittedAt = new Date().toISOString();
                
                await saveLecture(lecture);
                
                await loadUserLectures();
                
                alert('Лекция отправлена на проверку коменданту');
                
            } catch (error) {
                console.error('❌ Ошибка отправки лекции:', error);
                alert('Ошибка при отправке лекции');
            }
        }

        async function deleteLectureById(lectureId) {
            if (!confirm('Вы уверены, что хотите удалить эту лекцию?')) {
                return;
            }
            
            try {
                await deleteLecture(lectureId);
                await loadUserLectures();
                alert('Лекция удалена');
            } catch (error) {
                console.error('❌ Ошибка удаления лекции:', error);
                alert('Ошибка при удалении лекции');
            }
        }

        // ============================================
        // ПАНЕЛЬ КОМЕНДАНТА
        // ============================================

        async function loadCommanderPlatoonInfo() {
            try {
                const platoons = await loadPlatoons();
                const commanderPlatoon = platoons.find(p => p.commanderId === currentUser.id);
                
                const platoonInfo = document.getElementById('commander-platoon-info');
                const platoonMembers = document.getElementById('commander-platoon-members');
                
                if (!commanderPlatoon) {
                    platoonInfo.innerHTML = '<p>Вы не назначены комендантом ни одного взвода</p>';
                    platoonMembers.innerHTML = '';
                    return;
                }
                
                // Загружаем пользователей
                const users = await loadUsers();
                const platoonUsers = users.filter(u => u.platoonId === commanderPlatoon.id);
                
                // Информация о взводе
                platoonInfo.innerHTML = `
                    <h3>${commanderPlatoon.name}</h3>
                    <div class="platoon-info">
                        <div>ID взвода: ${commanderPlatoon.id}</div>
                        <div>Дата создания: ${new Date(commanderPlatoon.createdAt).toLocaleDateString('ru-RU')}</div>
                        <div>Количество участников: ${platoonUsers.length}</div>
                    </div>
                `;
                
                // Участники взвода
                if (platoonUsers.length === 0) {
                    platoonMembers.innerHTML = '<p>Во взводе пока нет участников</p>';
                    return;
                }
                
                platoonMembers.innerHTML = '<h4>Участники взвода:</h4>';
                
                platoonUsers.forEach(user => {
                    const memberItem = document.createElement('div');
                    memberItem.className = 'platoon-member';
                    
                    memberItem.innerHTML = `
                        <div>
                            <strong>${user.login}</strong>
                            <span class="user-role role-${user.role}">${getRoleDisplayName(user.role)}</span>
                            <span class="user-unit ${getUnitClass(user.unit)}">${getUnitDisplayName(user.unit)}</span>
                        </div>
                        <div>
                            <span class="user-stats">ID: ${user.id}</span>
                        </div>
                    `;
                    
                    platoonMembers.appendChild(memberItem);
                });
                
            } catch (error) {
                console.error('❌ Ошибка загрузки информации о взводе коменданта:', error);
                document.getElementById('commander-platoon-info').innerHTML = '<p>Ошибка при загрузке информации о взводе</p>';
            }
        }

        async function loadCommanderLecturesList() {
            try {
                const lectures = await loadLectures();
                const platoons = await loadPlatoons();
                const users = await loadUsers();
                
                // Находим взвод коменданта
                const commanderPlatoon = platoons.find(p => p.commanderId === currentUser.id);
                
                if (!commanderPlatoon) {
                    document.getElementById('commander-lectures-list').innerHTML = '<p>Вы не назначены комендантом ни одного взвода</p>';
                    return;
                }
                
                // Фильтруем лекции по взводу коменданта
                let platoonLectures = lectures.filter(l => l.userPlatoonId === commanderPlatoon.id);
                
                // Применяем фильтры
                const statusFilter = document.getElementById('commander-lecture-status').value;
                const authorFilter = document.getElementById('commander-lecture-author').value;
                
                if (statusFilter) {
                    platoonLectures = platoonLectures.filter(l => l.status === statusFilter);
                }
                
                if (authorFilter) {
                    platoonLectures = platoonLectures.filter(l => l.userId === authorFilter);
                }
                
                // Сортируем по дате отправки (новые сверху)
                platoonLectures.sort((a, b) => new Date(b.submittedAt || b.createdAt) - new Date(a.submittedAt || a.createdAt));
                
                const lecturesList = document.getElementById('commander-lectures-list');
                lecturesList.innerHTML = '';
                
                if (platoonLectures.length === 0) {
                    lecturesList.innerHTML = '<p>Нет лекций для проверки</p>';
                    return;
                }
                
                // Обновляем фильтр по автору
                const authorSelect = document.getElementById('commander-lecture-author');
                authorSelect.innerHTML = '<option value="">Все авторы</option>';
                
                const uniqueAuthors = [...new Set(platoonLectures.map(l => l.userId))];
                uniqueAuthors.forEach(authorId => {
                    const author = users.find(u => u.id === authorId);
                    if (author) {
                        const option = document.createElement('option');
                        option.value = authorId;
                        option.textContent = author.login;
                        authorSelect.appendChild(option);
                    }
                });
                
                // Отображаем лекции
                platoonLectures.forEach(lecture => {
                    const author = users.find(u => u.id === lecture.userId);
                    const lectureItem = document.createElement('div');
                    lectureItem.className = 'lecture-item';
                    
                    lectureItem.innerHTML = `
                        <div class="lecture-header">
                            <div>
                                <strong>${lecture.topic}</strong>
                                <span class="lecture-status ${getLectureStatusClass(lecture.status)}">${getLectureStatusDisplayName(lecture.status)}</span>
                            </div>
                            <div class="lecture-actions">
                                ${lecture.status === 'pending' ? `<button class="btn btn-success review-lecture" data-id="${lecture.id}">Проверить</button>` : ''}
                                <button class="btn btn-info view-lecture-commander" data-id="${lecture.id}">Просмотреть</button>
                            </div>
                        </div>
                        <div class="lecture-info">
                            <div>Автор: ${author ? author.login : 'Неизвестно'}</div>
                            <div>Создано: ${new Date(lecture.createdAt).toLocaleString('ru-RU')}</div>
                            ${lecture.submittedAt ? `<div>Отправлено на проверку: ${new Date(lecture.submittedAt).toLocaleString('ru-RU')}</div>` : ''}
                            ${lecture.reviewedAt ? `<div>Проверено: ${new Date(lecture.reviewedAt).toLocaleString('ru-RU')}</div>` : ''}
                            ${lecture.commanderNotes ? `<div class="commander-notes"><strong>Заметки коменданта:</strong> ${lecture.commanderNotes}</div>` : ''}
                        </div>
                        <div class="lecture-content" style="max-height: 100px;">
                            ${lecture.content.substring(0, 200)}${lecture.content.length > 200 ? '...' : ''}
                        </div>
                    `;
                    
                    lecturesList.appendChild(lectureItem);
                });
                
                // Добавляем обработчики событий
                lecturesList.querySelectorAll('.review-lecture').forEach(button => {
                    button.addEventListener('click', function() {
                        const lectureId = this.getAttribute('data-id');
                        openReviewLectureModal(lectureId);
                    });
                });
                
                lecturesList.querySelectorAll('.view-lecture-commander').forEach(button => {
                    button.addEventListener('click', function() {
                        const lectureId = this.getAttribute('data-id');
                        viewLectureAsCommander(lectureId);
                    });
                });
                
            } catch (error) {
                console.error('❌ Ошибка загрузки лекций для коменданта:', error);
                document.getElementById('commander-lectures-list').innerHTML = '<p>Ошибка при загрузке лекций</p>';
            }
        }

        async function openReviewLectureModal(lectureId) {
            try {
                const lectures = await loadLectures();
                const lecture = lectures.find(l => l.id === lectureId);
                const users = await loadUsers();
                const platoons = await loadPlatoons();
                
                if (!lecture) {
                    alert('Лекция не найдена');
                    return;
                }
                
                const author = users.find(u => u.id === lecture.userId);
                const platoon = platoons.find(p => p.id === lecture.userPlatoonId);
                
                reviewLectureModalTitle.textContent = 'Проверка лекции';
                reviewLectureAuthor.textContent = author ? author.login : 'Неизвестно';
                reviewLecturePlatoon.textContent = platoon ? platoon.name : 'Неизвестно';
                reviewLectureTopic.textContent = lecture.topic;
                reviewLectureContent.textContent = lecture.content;
                reviewLectureNotes.value = lecture.commanderNotes || '';
                reviewLectureDecision.value = '';
                
                // Сохраняем ID лекции для использования при проверке
                reviewLectureApproveBtn.setAttribute('data-lecture-id', lectureId);
                reviewLectureRejectBtn.setAttribute('data-lecture-id', lectureId);
                
                reviewLectureModal.style.display = 'block';
                
            } catch (error) {
                console.error('❌ Ошибка открытия модального окна проверки лекции:', error);
                alert('Ошибка при загрузке лекции');
            }
        }

        async function viewLectureAsCommander(lectureId) {
            try {
                const lectures = await loadLectures();
                const lecture = lectures.find(l => l.id === lectureId);
                
                if (!lecture) {
                    alert('Лекция не найдена');
                    return;
                }
                
                currentLectureModalMode = 'view';
                currentEditingLectureId = lectureId;
                
                lectureModalTitle.textContent = 'Просмотр лекции';
                lectureTopic.value = lecture.topic;
                lectureContent.value = lecture.content;
                lectureStatus.value = lecture.status;
                
                // Показываем заметки коменданта если они есть
                if (lecture.commanderNotes) {
                    lectureNotesSection.style.display = 'block';
                    lectureNotes.value = lecture.commanderNotes;
                } else {
                    lectureNotesSection.style.display = 'none';
                }
                
                // Скрываем кнопки сохранения и отправки
                lectureSaveBtn.style.display = 'none';
                lectureSubmitBtn.style.display = 'none';
                
                // Делаем поля только для чтения
                lectureTopic.disabled = true;
                lectureContent.disabled = true;
                
                lectureModal.style.display = 'block';
                
            } catch (error) {
                console.error('❌ Ошибка просмотра лекции:', error);
                alert('Ошибка при загрузке лекции');
            }
        }

        async function reviewLecture() {
            const lectureId = reviewLectureApproveBtn.getAttribute('data-lecture-id');
            const decision = reviewLectureDecision.value;
            const notes = reviewLectureNotes.value.trim();
            
            if (!decision) {
                alert('Выберите решение: одобрить или отклонить');
                return;
            }
            
            try {
                const lectures = await loadLectures();
                const lecture = lectures.find(l => l.id === lectureId);
                
                if (!lecture) {
                    alert('Лекция не найдена');
                    return;
                }
                
                // Обновляем лекцию
                lecture.status = decision;
                lecture.commanderNotes = notes;
                lecture.reviewedAt = new Date().toISOString();
                lecture.reviewedBy = currentUser.id;
                lecture.reviewedByName = currentUser.login;
                lecture.updatedAt = new Date().toISOString();
                
                await saveLecture(lecture);
                
                reviewLectureModal.style.display = 'none';
                await loadCommanderLecturesList();
                
                alert(`Лекция ${decision === 'approved' ? 'одобрена' : 'отклонена'}`);
                
            } catch (error) {
                console.error('❌ Ошибка проверки лекции:', error);
                alert('Ошибка при проверке лекции');
            }
        }

        async function loadCommanderLectureAssignments() {
            try {
                const platoons = await loadPlatoons();
                const users = await loadUsers();
                
                // Находим взвод коменданта
                const commanderPlatoon = platoons.find(p => p.commanderId === currentUser.id);
                
                if (!commanderPlatoon) {
                    document.getElementById('commander-lecture-assignments-list').innerHTML = '<p>Вы не назначены комендантом ни одного взвода</p>';
                    return;
                }
                
                // Загружаем лекции для взвода
                const lectures = await loadLectures();
                const platoonLectures = lectures.filter(l => l.userPlatoonId === commanderPlatoon.id);
                
                // Обновляем список пользователей для назначения тем
                const assignUserSelect = document.getElementById('assign-lecture-user');
                assignUserSelect.innerHTML = '<option value="">-- Выберите участника --</option>';
                
                const platoonUsers = users.filter(u => u.platoonId === commanderPlatoon.id && u.role !== 'commander');
                platoonUsers.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.login} (${getRoleDisplayName(user.role)})`;
                    assignUserSelect.appendChild(option);
                });
                
                // Отображаем текущие назначения
                const assignmentsList = document.getElementById('commander-lecture-assignments-list');
                assignmentsList.innerHTML = '';
                
                // Группируем лекции по пользователю
                const userLectures = {};
                platoonLectures.forEach(lecture => {
                    if (!userLectures[lecture.userId]) {
                        userLectures[lecture.userId] = [];
                    }
                    userLectures[lecture.userId].push(lecture);
                });
                
                // Отображаем для каждого пользователя
                platoonUsers.forEach(user => {
                    const userLecturesList = userLectures[user.id] || [];
                    
                    const userItem = document.createElement('div');
                    userItem.className = 'lecture-assignment-item';
                    
                    let lecturesHtml = '';
                    if (userLecturesList.length > 0) {
                        userLecturesList.forEach(lecture => {
                            lecturesHtml += `
                                <div class="lecture-assignment-header">
                                    <div>
                                        <strong>${lecture.topic}</strong>
                                        <span class="lecture-status ${getLectureStatusClass(lecture.status)}">${getLectureStatusDisplayName(lecture.status)}</span>
                                    </div>
                                    <div>
                                        <button class="btn btn-info btn-sm view-assigned-lecture" data-id="${lecture.id}">Просмотреть</button>
                                    </div>
                                </div>
                                <div class="lecture-info">
                                    <div>Статус: ${getLectureStatusDisplayName(lecture.status)}</div>
                                    <div>Создано: ${new Date(lecture.createdAt).toLocaleDateString('ru-RU')}</div>
                                </div>
                            `;
                        });
                    } else {
                        lecturesHtml = '<p>У этого пользователя пока нет лекций</p>';
                    }
                    
                    userItem.innerHTML = `
                        <div>
                            <h4>${user.login} (${getRoleDisplayName(user.role)})</h4>
                            ${lecturesHtml}
                        </div>
                    `;
                    
                    assignmentsList.appendChild(userItem);
                });
                
                // Добавляем обработчики событий
                assignmentsList.querySelectorAll('.view-assigned-lecture').forEach(button => {
                    button.addEventListener('click', function() {
                        const lectureId = this.getAttribute('data-id');
                        viewLectureAsCommander(lectureId);
                    });
                });
                
            } catch (error) {
                console.error('❌ Ошибка загрузки назначений лекций:', error);
                document.getElementById('commander-lecture-assignments-list').innerHTML = '<p>Ошибка при загрузке назначений</p>';
            }
        }

        async function assignLecture() {
            const userId = document.getElementById('assign-lecture-user').value;
            const topic = document.getElementById('assign-lecture-topic').value.trim();
            
            if (!userId) {
                alert('Выберите участника взвода');
                return;
            }
            
            if (!topic) {
                alert('Введите тему лекции');
                return;
            }
            
            try {
                const users = await loadUsers();
                const platoons = await loadPlatoons();
                
                const user = users.find(u => u.id === userId);
                if (!user) {
                    alert('Пользователь не найден');
                    return;
                }
                
                // Находим взвод коменданта
                const commanderPlatoon = platoons.find(p => p.commanderId === currentUser.id);
                if (!commanderPlatoon) {
                    alert('Вы не назначены комендантом ни одного взвода');
                    return;
                }
                
                // Проверяем, что пользователь в том же взводе
                if (user.platoonId !== commanderPlatoon.id) {
                    alert('Пользователь не в вашем взводе');
                    return;
                }
                
                // Создаем лекцию-задание
                const lecture = {
                    userId: userId,
                    userName: user.login,
                    userPlatoonId: commanderPlatoon.id,
                    topic: topic,
                    content: 'Лекция еще не написана. Пользователь должен написать содержание этой лекции.',
                    status: 'draft',
                    isAssigned: true,
                    assignedBy: currentUser.id,
                    assignedByName: currentUser.login,
                    assignedAt: new Date().toISOString(),
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                await saveLecture(lecture);
                
                document.getElementById('assign-lecture-topic').value = '';
                await loadCommanderLectureAssignments();
                
                alert('Тема лекции назначена пользователю');
                
            } catch (error) {
                console.error('❌ Ошибка назначения темы лекции:', error);
                alert('Ошибка при назначении темы лекции');
            }
        }

        // ============================================
        // АДМИН ПАНЕЛЬ - УПРАВЛЕНИЕ ВЗВОДАМИ
        // ============================================

        async function loadPlatoonsList() {
            try {
                const platoons = await loadPlatoons();
                const users = await loadUsers();
                
                const platoonsList = document.getElementById('platoons-list');
                platoonsList.innerHTML = '';
                
                // Обновляем список комендантов для создания нового взвода
                const newCommanderSelect = document.getElementById('new-platoon-commander');
                newCommanderSelect.innerHTML = '<option value="">-- Выберите коменданта --</option>';
                
                const commanders = users.filter(u => u.role === 'commander' && (!u.platoonId || u.platoonId === ''));
                commanders.forEach(commander => {
                    const option = document.createElement('option');
                    option.value = commander.id;
                    option.textContent = `${commander.login} (${getUnitDisplayName(commander.unit)})`;
                    newCommanderSelect.appendChild(option);
                });
                
                if (platoons.length === 0) {
                    platoonsList.innerHTML = '<p>Взводы не созданы</p>';
                    return;
                }
                
                platoons.forEach(platoon => {
                    const commander = users.find(u => u.id === platoon.commanderId);
                    const platoonUsers = users.filter(u => u.platoonId === platoon.id);
                    
                    const platoonItem = document.createElement('div');
                    platoonItem.className = 'platoon-item';
                    
                    platoonItem.innerHTML = `
                        <div class="platoon-header">
                            <div>
                                <strong>${platoon.name}</strong>
                                ${commander ? `<span class="platoon-commander">Комендант: ${commander.login}</span>` : ''}
                            </div>
                            <div class="platoon-actions">
                                <button class="btn btn-warning edit-platoon" data-id="${platoon.id}">Редактировать</button>
                                <button class="btn btn-danger delete-platoon" data-id="${platoon.id}">Удалить</button>
                            </div>
                        </div>
                        <div class="platoon-info">
                            <div>ID: ${platoon.id}</div>
                            <div>Создан: ${new Date(platoon.createdAt).toLocaleDateString('ru-RU')}</div>
                            <div>Участников: ${platoonUsers.length}</div>
                        </div>
                        <div class="platoon-members">
                            <h5>Участники (${platoonUsers.length}):</h5>
                            ${platoonUsers.length > 0 ? 
                                platoonUsers.map(user => `
                                    <div class="platoon-member">
                                        <div>${user.login} (${getRoleDisplayName(user.role)}, ${getUnitDisplayName(user.unit)})</div>
                                    </div>
                                `).join('') : 
                                '<p>Во взводе нет участников</p>'
                            }
                        </div>
                    `;
                    
                    platoonsList.appendChild(platoonItem);
                });
                
                // Добавляем обработчики событий
                platoonsList.querySelectorAll('.edit-platoon').forEach(button => {
                    button.addEventListener('click', function() {
                        const platoonId = this.getAttribute('data-id');
                        editPlatoon(platoonId);
                    });
                });
                
                platoonsList.querySelectorAll('.delete-platoon').forEach(button => {
                    button.addEventListener('click', function() {
                        const platoonId = this.getAttribute('data-id');
                        deletePlatoonById(platoonId);
                    });
                });
                
            } catch (error) {
                console.error('❌ Ошибка загрузки списка взводов:', error);
                document.getElementById('platoons-list').innerHTML = '<p>Ошибка при загрузке взводов</p>';
            }
        }

        async function addPlatoon() {
            const name = newPlatoonName.value.trim();
            const commanderId = newPlatoonCommander.value;
            
            if (!name) {
                document.getElementById('platoon-add-error').textContent = 'Введите название взвода';
                document.getElementById('platoon-add-error').classList.remove('hidden');
                return;
            }
            
            try {
                const platoons = await loadPlatoons();
                
                const existingPlatoon = platoons.find(p => p.name === name);
                if (existingPlatoon) {
                    document.getElementById('platoon-add-error').textContent = 'Взвод с таким названием уже существует';
                    document.getElementById('platoon-add-error').classList.remove('hidden');
                    return;
                }
                
                const newPlatoon = {
                    name: name,
                    commanderId: commanderId || '',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                await savePlatoon(newPlatoon);
                
                // Если назначен комендант, обновляем его запись
                if (commanderId) {
                    const users = await loadUsers();
                    const commander = users.find(u => u.id === commanderId);
                    if (commander) {
                        commander.platoonId = newPlatoon.id;
                        await saveUser(commander);
                    }
                }
                
                newPlatoonName.value = '';
                newPlatoonCommander.value = '';
                
                document.getElementById('platoon-add-success').classList.remove('hidden');
                document.getElementById('platoon-add-error').classList.add('hidden');
                
                await loadPlatoonsList();
                await updatePlatoonSelects();
                
                setTimeout(() => {
                    document.getElementById('platoon-add-success').classList.add('hidden');
                }, 3000);
                
            } catch (error) {
                console.error('❌ Ошибка добавления взвода:', error);
                document.getElementById('platoon-add-error').textContent = 'Ошибка при создании взвода';
                document.getElementById('platoon-add-error').classList.remove('hidden');
            }
        }

        async function editPlatoon(platoonId) {
            try {
                const platoons = await loadPlatoons();
                const platoon = platoons.find(p => p.id === platoonId);
                
                if (!platoon) {
                    alert('Взвод не найден');
                    return;
                }
                
                const users = await loadUsers();
                
                // Заполняем форму редактирования
                document.getElementById('edit-platoon-name').value = platoon.name;
                
                // Обновляем список комендантов для редактирования
                const editCommanderSelect = document.getElementById('edit-platoon-commander');
                editCommanderSelect.innerHTML = '<option value="">-- Выберите коменданта --</option>';
                
                const commanders = users.filter(u => u.role === 'commander');
                commanders.forEach(commander => {
                    const option = document.createElement('option');
                    option.value = commander.id;
                    option.textContent = `${commander.login} (${getUnitDisplayName(commander.unit)})`;
                    if (commander.id === platoon.commanderId) {
                        option.selected = true;
                    }
                    editCommanderSelect.appendChild(option);
                });
                
                // Показываем редактор
                document.getElementById('platoon-editor').classList.remove('hidden');
                document.getElementById('save-platoon').setAttribute('data-id', platoonId);
                
            } catch (error) {
                console.error('❌ Ошибка редактирования взвода:', error);
                alert('Ошибка при загрузке данных взвода');
            }
        }

        async function savePlatoonChanges() {
            const platoonId = document.getElementById('save-platoon').getAttribute('data-id');
            const name = document.getElementById('edit-platoon-name').value.trim();
            const commanderId = document.getElementById('edit-platoon-commander').value;
            
            if (!name) {
                alert('Введите название взвода');
                return;
            }
            
            try {
                const platoons = await loadPlatoons();
                const platoonIndex = platoons.findIndex(p => p.id === platoonId);
                
                if (platoonIndex === -1) {
                    alert('Взвод не найден');
                    return;
                }
                
                const nameExists = platoons.some(p => p.id !== platoonId && p.name === name);
                if (nameExists) {
                    alert('Взвод с таким названием уже существует');
                    return;
                }
                
                const users = await loadUsers();
                
                // Получаем старый комендант
                const oldCommanderId = platoons[platoonIndex].commanderId;
                
                // Обновляем взвод
                const updatedPlatoon = {
                    ...platoons[platoonIndex],
                    name: name,
                    commanderId: commanderId || '',
                    updatedAt: new Date().toISOString()
                };
                
                await savePlatoon(updatedPlatoon);
                
                // Обновляем старый комендант (убираем привязку к взводу)
                if (oldCommanderId && oldCommanderId !== commanderId) {
                    const oldCommander = users.find(u => u.id === oldCommanderId);
                    if (oldCommander) {
                        oldCommander.platoonId = '';
                        await saveUser(oldCommander);
                    }
                }
                
                // Обновляем нового коменданта (добавляем привязку к взводу)
                if (commanderId) {
                    const newCommander = users.find(u => u.id === commanderId);
                    if (newCommander) {
                        newCommander.platoonId = platoonId;
                        await saveUser(newCommander);
                    }
                }
                
                document.getElementById('platoon-editor').classList.add('hidden');
                await loadPlatoonsList();
                await updatePlatoonSelects();
                
            } catch (error) {
                console.error('❌ Ошибка сохранения взвода:', error);
                alert('Ошибка при сохранении взвода');
            }
        }

        function cancelPlatoonEdit() {
            document.getElementById('platoon-editor').classList.add('hidden');
        }

        async function deletePlatoonById(platoonId) {
            if (!confirm('Вы уверены, что хотите удалить этот взвод? Все участники будут откреплены от взвода.')) {
                return;
            }
            
            try {
                await deletePlatoon(platoonId);
                await loadPlatoonsList();
                await updatePlatoonSelects();
                alert('Взвод удален');
            } catch (error) {
                console.error('❌ Ошибка удаления взвода:', error);
                alert('Ошибка при удалении взвода');
            }
        }

        async function updatePlatoonSelects() {
            const platoons = await loadPlatoons();
            
            // Обновляем select для пользователей в админ панели
            const adminPlatoonSelect = document.getElementById('edit-user-platoon');
            adminPlatoonSelect.innerHTML = '<option value="">Без взвода</option>';
            
            platoons.forEach(platoon => {
                const option = document.createElement('option');
                option.value = platoon.id;
                option.textContent = platoon.name;
                adminPlatoonSelect.appendChild(option);
            });
            
            // Обновляем select для пользователей в куратор панели
            const curatorPlatoonSelect = document.getElementById('edit-user-platoon-curator');
            if (curatorPlatoonSelect) {
                curatorPlatoonSelect.innerHTML = '<option value="">Без взвода</option>';
                platoons.forEach(platoon => {
                    const option = document.createElement('option');
                    option.value = platoon.id;
                    option.textContent = platoon.name;
                    curatorPlatoonSelect.appendChild(option);
                });
            }
            
            // Обновляем select для фильтрации лекций
            const adminLecturePlatoonSelect = document.getElementById('admin-lecture-platoon');
            const curatorLecturePlatoonSelect = document.getElementById('curator-lecture-platoon');
            
            if (adminLecturePlatoonSelect) {
                adminLecturePlatoonSelect.innerHTML = '<option value="">Все взводы</option>';
                platoons.forEach(platoon => {
                    const option = document.createElement('option');
                    option.value = platoon.id;
                    option.textContent = platoon.name;
                    adminLecturePlatoonSelect.appendChild(option);
                });
            }
            
            if (curatorLecturePlatoonSelect) {
                curatorLecturePlatoonSelect.innerHTML = '<option value="">Все взводы</option>';
                platoons.forEach(platoon => {
                    const option = document.createElement('option');
                    option.value = platoon.id;
                    option.textContent = platoon.name;
                    curatorLecturePlatoonSelect.appendChild(option);
                });
            }
        }

        // ============================================
        // АДМИН ПАНЕЛЬ - ПРОСМОТР ЛЕКЦИЙ
        // ============================================

        async function loadAdminLecturesList() {
            try {
                const lectures = await loadLectures();
                const users = await loadUsers();
                const platoons = await loadPlatoons();
                
                // Применяем фильтры
                const statusFilter = document.getElementById('admin-lecture-status').value;
                const platoonFilter = document.getElementById('admin-lecture-platoon').value;
                const authorFilter = document.getElementById('admin-lecture-author').value;
                
                let filteredLectures = lectures;
                
                if (statusFilter) {
                    filteredLectures = filteredLectures.filter(l => l.status === statusFilter);
                }
                
                if (platoonFilter) {
                    filteredLectures = filteredLectures.filter(l => l.userPlatoonId === platoonFilter);
                }
                
                if (authorFilter) {
                    filteredLectures = filteredLectures.filter(l => l.userId === authorFilter);
                }
                
                // Сортируем по дате создания (новые сверху)
                filteredLectures.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                const lecturesList = document.getElementById('admin-lectures-list');
                lecturesList.innerHTML = '';
                
                if (filteredLectures.length === 0) {
                    lecturesList.innerHTML = '<p>Лекции не найдены</p>';
                    return;
                }
                
                // Обновляем фильтры
                const authorSelect = document.getElementById('admin-lecture-author');
                authorSelect.innerHTML = '<option value="">Все авторы</option>';
                
                const uniqueAuthors = [...new Set(filteredLectures.map(l => l.userId))];
                uniqueAuthors.forEach(authorId => {
                    const author = users.find(u => u.id === authorId);
                    if (author) {
                        const option = document.createElement('option');
                        option.value = authorId;
                        option.textContent = author.login;
                        if (authorId === authorFilter) {
                            option.selected = true;
                        }
                        authorSelect.appendChild(option);
                    }
                });
                
                // Отображаем лекции
                filteredLectures.forEach(lecture => {
                    const author = users.find(u => u.id === lecture.userId);
                    const platoon = platoons.find(p => p.id === lecture.userPlatoonId);
                    
                    const lectureItem = document.createElement('div');
                    lectureItem.className = 'lecture-item';
                    
                    lectureItem.innerHTML = `
                        <div class="lecture-header">
                            <div>
                                <strong>${lecture.topic}</strong>
                                <span class="lecture-status ${getLectureStatusClass(lecture.status)}">${getLectureStatusDisplayName(lecture.status)}</span>
                            </div>
                            <div class="lecture-actions">
                                <button class="btn btn-info view-lecture-admin" data-id="${lecture.id}">Просмотреть</button>
                                <button class="btn btn-danger delete-lecture-admin" data-id="${lecture.id}">Удалить</button>
                            </div>
                        </div>
                        <div class="lecture-info">
                            <div>Автор: ${author ? author.login : 'Неизвестно'}</div>
                            ${platoon ? `<div>Взвод: ${platoon.name}</div>` : ''}
                            <div>Создано: ${new Date(lecture.createdAt).toLocaleString('ru-RU')}</div>
                            ${lecture.submittedAt ? `<div>Отправлено на проверку: ${new Date(lecture.submittedAt).toLocaleString('ru-RU')}</div>` : ''}
                            ${lecture.reviewedAt ? `<div>Проверено: ${new Date(lecture.reviewedAt).toLocaleString('ru-RU')}</div>` : ''}
                            ${lecture.reviewedBy ? `<div>Проверил: ${lecture.reviewedByName || 'Комендант'}</div>` : ''}
                            ${lecture.commanderNotes ? `<div class="commander-notes"><strong>Заметки коменданта:</strong> ${lecture.commanderNotes}</div>` : ''}
                        </div>
                        <div class="lecture-content" style="max-height: 100px;">
                            ${lecture.content.substring(0, 200)}${lecture.content.length > 200 ? '...' : ''}
                        </div>
                    `;
                    
                    lecturesList.appendChild(lectureItem);
                });
                
                // Добавляем обработчики событий
                lecturesList.querySelectorAll('.view-lecture-admin').forEach(button => {
                    button.addEventListener('click', function() {
                        const lectureId = this.getAttribute('data-id');
                        viewLectureAsAdmin(lectureId);
                    });
                });
                
                lecturesList.querySelectorAll('.delete-lecture-admin').forEach(button => {
                    button.addEventListener('click', function() {
                        const lectureId = this.getAttribute('data-id');
                        deleteLectureAdmin(lectureId);
                    });
                });
                
            } catch (error) {
                console.error('❌ Ошибка загрузки лекций для администратора:', error);
                document.getElementById('admin-lectures-list').innerHTML = '<p>Ошибка при загрузке лекций</p>';
            }
        }

        async function viewLectureAsAdmin(lectureId) {
            try {
                const lectures = await loadLectures();
                const lecture = lectures.find(l => l.id === lectureId);
                
                if (!lecture) {
                    alert('Лекция не найдена');
                    return;
                }
                
                currentLectureModalMode = 'view';
                currentEditingLectureId = lectureId;
                
                lectureModalTitle.textContent = 'Просмотр лекции (администратор)';
                lectureTopic.value = lecture.topic;
                lectureContent.value = lecture.content;
                lectureStatus.value = lecture.status;
                
                // Показываем заметки коменданта если они есть
                if (lecture.commanderNotes) {
                    lectureNotesSection.style.display = 'block';
                    lectureNotes.value = lecture.commanderNotes;
                } else {
                    lectureNotesSection.style.display = 'none';
                }
                
                // Скрываем кнопки сохранения и отправки
                lectureSaveBtn.style.display = 'none';
                lectureSubmitBtn.style.display = 'none';
                
                // Делаем поля только для чтения
                lectureTopic.disabled = true;
                lectureContent.disabled = true;
                
                lectureModal.style.display = 'block';
                
            } catch (error) {
                console.error('❌ Ошибка просмотра лекции:', error);
                alert('Ошибка при загрузке лекции');
            }
        }

        async function deleteLectureAdmin(lectureId) {
            if (!confirm('Вы уверены, что хотите удалить эту лекцию?')) {
                return;
            }
            
            try {
                await deleteLecture(lectureId);
                await loadAdminLecturesList();
                alert('Лекция удалена');
            } catch (error) {
                console.error('❌ Ошибка удаления лекции:', error);
                alert('Ошибка при удалении лекции');
            }
        }

        // ============================================
        // КУРАТОР ПАНЕЛЬ - ПРОСМОТР ЛЕКЦИЙ
        // ============================================

        async function loadCuratorLecturesList() {
            try {
                const lectures = await loadLectures();
                const users = await loadUsers();
                const platoons = await loadPlatoons();
                
                // Применяем фильтры
                const statusFilter = document.getElementById('curator-lecture-status').value;
                const platoonFilter = document.getElementById('curator-lecture-platoon').value;
                const authorFilter = document.getElementById('curator-lecture-author').value;
                
                let filteredLectures = lectures;
                
                if (statusFilter) {
                    filteredLectures = filteredLectures.filter(l => l.status === statusFilter);
                }
                
                if (platoonFilter) {
                    filteredLectures = filteredLectures.filter(l => l.userPlatoonId === platoonFilter);
                }
                
                if (authorFilter) {
                    filteredLectures = filteredLectures.filter(l => l.userId === authorFilter);
                }
                
                // Сортируем по дате создания (новые сверху)
                filteredLectures.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                const lecturesList = document.getElementById('curator-lectures-list');
                lecturesList.innerHTML = '';
                
                if (filteredLectures.length === 0) {
                    lecturesList.innerHTML = '<p>Лекции не найдены</p>';
                    return;
                }
                
                // Отображаем лекции
                filteredLectures.forEach(lecture => {
                    const author = users.find(u => u.id === lecture.userId);
                    const platoon = platoons.find(p => p.id === lecture.userPlatoonId);
                    
                    const lectureItem = document.createElement('div');
                    lectureItem.className = 'lecture-item';
                    
                    lectureItem.innerHTML = `
                        <div class="lecture-header">
                            <div>
                                <strong>${lecture.topic}</strong>
                                <span class="lecture-status ${getLectureStatusClass(lecture.status)}">${getLectureStatusDisplayName(lecture.status)}</span>
                            </div>
                            <div class="lecture-actions">
                                <button class="btn btn-info view-lecture-curator" data-id="${lecture.id}">Просмотреть</button>
                            </div>
                        </div>
                        <div class="lecture-info">
                            <div>Автор: ${author ? author.login : 'Неизвестно'}</div>
                            ${platoon ? `<div>Взвод: ${platoon.name}</div>` : ''}
                            <div>Создано: ${new Date(lecture.createdAt).toLocaleString('ru-RU')}</div>
                            ${lecture.submittedAt ? `<div>Отправлено на проверку: ${new Date(lecture.submittedAt).toLocaleString('ru-RU')}</div>` : ''}
                            ${lecture.reviewedAt ? `<div>Проверено: ${new Date(lecture.reviewedAt).toLocaleString('ru-RU')}</div>` : ''}
                            ${lecture.reviewedBy ? `<div>Проверил: ${lecture.reviewedByName || 'Комендант'}</div>` : ''}
                            ${lecture.commanderNotes ? `<div class="commander-notes"><strong>Заметки коменданта:</strong> ${lecture.commanderNotes}</div>` : ''}
                        </div>
                        <div class="lecture-content" style="max-height: 100px;">
                            ${lecture.content.substring(0, 200)}${lecture.content.length > 200 ? '...' : ''}
                        </div>
                    `;
                    
                    lecturesList.appendChild(lectureItem);
                });
                
                // Добавляем обработчики событий
                lecturesList.querySelectorAll('.view-lecture-curator').forEach(button => {
                    button.addEventListener('click', function() {
                        const lectureId = this.getAttribute('data-id');
                        viewLectureAsCurator(lectureId);
                    });
                });
                
            } catch (error) {
                console.error('❌ Ошибка загрузки лекций для куратора:', error);
                document.getElementById('curator-lectures-list').innerHTML = '<p>Ошибка при загрузке лекций</p>';
            }
        }

        async function viewLectureAsCurator(lectureId) {
            try {
                const lectures = await loadLectures();
                const lecture = lectures.find(l => l.id === lectureId);
                
                if (!lecture) {
                    alert('Лекция не найдена');
                    return;
                }
                
                currentLectureModalMode = 'view';
                currentEditingLectureId = lectureId;
                
                lectureModalTitle.textContent = 'Просмотр лекции (куратор)';
                lectureTopic.value = lecture.topic;
                lectureContent.value = lecture.content;
                lectureStatus.value = lecture.status;
                
                // Показываем заметки коменданта если они есть
                if (lecture.commanderNotes) {
                    lectureNotesSection.style.display = 'block';
                    lectureNotes.value = lecture.commanderNotes;
                } else {
                    lectureNotesSection.style.display = 'none';
                }
                
                // Скрываем кнопки сохранения и отправки
                lectureSaveBtn.style.display = 'none';
                lectureSubmitBtn.style.display = 'none';
                
                // Делаем поля только для чтения
                lectureTopic.disabled = true;
                lectureContent.disabled = true;
                
                lectureModal.style.display = 'block';
                
            } catch (error) {
                console.error('❌ Ошибка просмотра лекции:', error);
                alert('Ошибка при загрузке лекции');
            }
        }

        // Остальные функции остаются без изменений...
        // [Здесь должен быть остальной код из предыдущей версии]
        // Из-за ограничения длины ответа я не могу вставить весь код, 
        // но все основные функции для работы с пользователями, тестами и т.д. остаются

        // Пожалуйста, добавьте остальные функции из предыдущего кода здесь:
        // loadUsersList, addUser, saveUserChanges, cancelUserEdit, 
        // loadQuestionSetsList, addQuestionSet, loadQuestionsForSet,
        // addNewQuestion, openEditQuestionModal, saveModalQuestion,
        // deleteQuestion, loadAssignmentsList, assignTest, 
        // loadUserAnswersList, и все остальные функции

        // Эти функции остаются практически без изменений, 
        // за исключением добавления поддержки поля platoonId в пользователях

    </script>
</body>
</html>
